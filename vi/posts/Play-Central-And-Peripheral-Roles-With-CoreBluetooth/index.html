<!doctype html>
<html lang="vi"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ƒê√≥ng Vai Tr√≤ Central V√† Peripheral V·ªõi CoreBluetooth - Uy Nguyen</title><meta description="Gi·ªõi thi·ªáuNh∆∞ t√¥i ƒë√£ ƒë·ªÅ c·∫≠p trong b√†i vi·∫øt tr∆∞·ªõc, CoreBluetooth cho ph√©p ch√∫ng ta t·∫°o c√°c ·ª©ng d·ª•ng c√≥ th·ªÉ giao ti·∫øp v·ªõi c√°c thi·∫øt b·ªã BLE nh∆∞ m√°y ƒëo nh·ªãp tim, c·∫£m bi·∫øn c∆° th·ªÉ, thi·∫øt b·ªã theo d√µi ho·∫∑c c√°"><meta property="og:type" content="blog"><meta property="og:title" content="ƒê√≥ng Vai Tr√≤ Central V√† Peripheral V·ªõi CoreBluetooth"><meta property="og:url" content=":year/:month/:day/:title/"><meta property="og:site_name" content="Uy Nguyen"><meta property="og:description" content="Gi·ªõi thi·ªáuNh∆∞ t√¥i ƒë√£ ƒë·ªÅ c·∫≠p trong b√†i vi·∫øt tr∆∞·ªõc, CoreBluetooth cho ph√©p ch√∫ng ta t·∫°o c√°c ·ª©ng d·ª•ng c√≥ th·ªÉ giao ti·∫øp v·ªõi c√°c thi·∫øt b·ªã BLE nh∆∞ m√°y ƒëo nh·ªãp tim, c·∫£m bi·∫øn c∆° th·ªÉ, thi·∫øt b·ªã theo d√µi ho·∫∑c c√°"><meta property="og:locale" content="vi_VN"><meta property="article:published_time" content="2018-02-21T14:01:26.000Z"><meta property="article:modified_time" content="2026-01-26T06:49:48.790Z"><meta property="article:author" content="Uy Nguyen"><meta property="article:tag" content="iOS"><meta property="article:tag" content="CoreBluetooh"><meta property="article:tag" content="BLE"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/Post-Resources/PlayRolesInCoreBluetooth/Banner.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://uynguyen.github.io/vi/posts/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/index.html"},"headline":"Uy Nguyen","image":["https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/Banner.jpg","https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/UUIDGen.png","https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/Peripheral_Result.png","https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/Scan_Devices.png","https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/Paring_Request.png","https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/Demo.gif","https://uynguyen.github.io/Post-Resources/PlayRolesInCoreBluetooth/Programming_Flow_BLE.png"],"datePublished":"2018-02-21T14:01:26.000Z","dateModified":"2026-01-26T06:49:48.790Z","author":{"@type":"Person","name":"Uy Nguyen"},"description":"Gi·ªõi thi·ªáuNh∆∞ t√¥i ƒë√£ ƒë·ªÅ c·∫≠p trong b√†i vi·∫øt tr∆∞·ªõc, CoreBluetooth cho ph√©p ch√∫ng ta t·∫°o c√°c ·ª©ng d·ª•ng c√≥ th·ªÉ giao ti·∫øp v·ªõi c√°c thi·∫øt b·ªã BLE nh∆∞ m√°y ƒëo nh·ªãp tim, c·∫£m bi·∫øn c∆° th·ªÉ, thi·∫øt b·ªã theo d√µi ho·∫∑c c√°"}</script><link rel="canonical" href="https://uynguyen.github.io/vi/posts/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/index.html"><link rel="icon" href="/Post-Resources/UyNguyen.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><meta property="og:image" content="/Post-Resources/PlayRolesInCoreBluetooth/Banner.jpg"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-163508356-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-163508356-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><div class="navbar-item has-dropdown is-hoverable language-switcher"><a class="navbar-link" title="Language"><i class="fas fa-globe"></i></a><div class="navbar-dropdown is-right"><a class="navbar-item" href="/2018/02/21/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/">English</a><a class="navbar-item is-active" href="/vi/posts/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/">Ti·∫øng Vi·ªát</a><a class="navbar-item" href="/es/posts/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/">Espa√±ol</a></div></div><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"></div></div><h1 class="title is-3 is-size-4-mobile">ƒê√≥ng Vai Tr√≤ Central V√† Peripheral V·ªõi CoreBluetooth</h1><div class="content"><h2 id="Gioi-thieu"><a href="#Gioi-thieu" class="headerlink" title="Gi·ªõi thi·ªáu"></a>Gi·ªõi thi·ªáu</h2><p><img src="/Post-Resources/PlayRolesInCoreBluetooth/Banner.jpg" alt="" title="I love CoreBluetooth"><br>Nh∆∞ t√¥i ƒë√£ ƒë·ªÅ c·∫≠p trong <a href="/2017/10/13/Bluetooth-Low-Energy-On-iOS/">b√†i vi·∫øt tr∆∞·ªõc</a>, CoreBluetooth cho ph√©p ch√∫ng ta t·∫°o c√°c ·ª©ng d·ª•ng c√≥ th·ªÉ giao ti·∫øp v·ªõi c√°c thi·∫øt b·ªã BLE nh∆∞ m√°y ƒëo nh·ªãp tim, c·∫£m bi·∫øn c∆° th·ªÉ, thi·∫øt b·ªã theo d√µi ho·∫∑c c√°c thi·∫øt b·ªã hybrid.<br>C√≥ hai vai tr√≤ trong c√°c kh√°i ni·ªám CoreBluetooth: Central v√† peripheral.</p>
<ul>
<li>Central: L·∫•y d·ªØ li·ªáu t·ª´ c√°c peripheral.</li>
<li>Peripheral: Ph√°t h√†nh d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞·ª£c truy c·∫≠p b·ªüi central. Ch√∫ng ta c√≥ th·ªÉ l√†m cho m·ªôt thi·∫øt b·ªã Bluetooth ƒë√≥ng vai tr√≤ peripheral t·ª´ ph√≠a firmware ho·∫∑c ph√≠a software.</li>
</ul>
<p>Trong b√†i vi·∫øt n√†y, t√¥i s·∫Ω h∆∞·ªõng d·∫´n b·∫°n c√°ch t·∫°o m·ªôt peripheral b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c identifier c·ªßa ri√™ng ch√∫ng ta. C≈©ng nh∆∞ s·ª≠ d·ª•ng m·ªôt thi·∫øt b·ªã kh√°c, l√†m central, ƒë·ªÉ k·∫øt n·ªëi v√† kh√°m ph√° c√°c service c·ªßa ch√∫ng ta. H√£y b·∫Øt ƒë·∫ßu.</p>
<a id="more"></a>
<h2 id="Thiet-lap-Peripheral"><a href="#Thiet-lap-Peripheral" class="headerlink" title="Thi·∫øt l·∫≠p Peripheral"></a>Thi·∫øt l·∫≠p Peripheral</h2><p>ƒê·ªÉ t·∫°o m·ªôt service, b·∫°n c·∫ßn c√≥ m·ªôt identifier duy nh·∫•t g·ªçi l√† UUID. M·ªôt service ti√™u chu·∫©n c√≥ UUID 16-bit v√† m·ªôt service t√πy ch·ªânh c√≥ UUID 128-bit. H√£y g√µ l·ªánh sau ƒë·ªÉ t·∫°o m·ªôt uuid duy nh·∫•t t·ª´ terminal c·ªßa b·∫°n.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ uuidgen</span><br></pre></td></tr></table></figure>
<p><img src="/Post-Resources/PlayRolesInCoreBluetooth/UUIDGen.png" alt=""></p>
<p>Nh∆∞ b·∫°n th·∫•y, l·ªánh tr·∫£ v·ªÅ m·ªôt uuid ·ªü ƒë·ªãnh d·∫°ng hexa (128 bit): <code>A56E51F3-AFFE-4E14-87A2-54927B22354C</code>. Ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng chu·ªói n√†y ƒë·ªÉ thi·∫øt l·∫≠p service c·ªßa ri√™ng m√¨nh.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span>, <span class="title">CBPeripheralManagerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> kServiceUUID = <span class="string">"A56E51F3-AFFE-4E14-87A2-54927B22354C"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Other properties</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidAppear(animated)</span><br><span class="line">        peripheralManager = <span class="type">CBPeripheralManager</span>(delegate: <span class="keyword">self</span>, queue: <span class="literal">nil</span>)  [<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">peripheralManagerDidUpdateState</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheralManager)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"peripheralManagerDidUpdateState \(peripheral.state.rawValue)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> peripheral.state == .poweredOn &#123;</span><br><span class="line">            <span class="keyword">let</span> serviceUUID = <span class="type">CBUUID</span>(string: kServiceUUID) [<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">self</span>.service = <span class="type">CBMutableService</span>(type: serviceUUID, primary: <span class="literal">true</span>) [<span class="number">3</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Other code</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ƒê√¢y l√† nh·ªØng g√¨ c√°c ph∆∞∆°ng th·ª©c n√†y l√†m:</p>
<ul>
<li>[1] B·∫°n t·∫°o m·ªôt instance c·ªßa class <code>PeripheralManager</code>, s·∫Ω ƒë√≥ng vai tr√≤ peripheral trong v√≠ d·ª• c·ªßa ch√∫ng ta. L∆∞u √Ω r·∫±ng c√≥ m·ªôt tham s·ªë <code>queue</code> trong constructor. C√°c event c·ªßa vai tr√≤ peripheral s·∫Ω ƒë∆∞·ª£c dispatch tr√™n queue ƒë∆∞·ª£c cung c·∫•p. N·∫øu ch√∫ng ta truy·ªÅn <code>nil</code>, main queue s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.</li>
<li>[2] ƒê·ªÉ thi·∫øt l·∫≠p m·ªôt service, ch√∫ng ta c·∫ßn t·∫°o m·ªôt instance c·ªßa class <code>CBUUID</code>. Constructor nh·∫≠n m·ªôt uuid duy nh·∫•t l√†m tham s·ªë, ƒë·ªÉ ph√¢n bi·ªát service c·ªßa ch√∫ng ta v·ªõi c√°c service kh√°c.</li>
<li>[3] Ch√∫ng ta t·∫°o m·ªôt instance c·ªßa class <code>CBMutableService</code>. Constructor nh·∫≠n hai tham s·ªë: Tham s·ªë ƒë·∫ßu ti√™n l√† uuid duy nh·∫•t c·ªßa ch√∫ng ta, ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a t·∫°i [2]; tham s·ªë th·ª© hai ch·ªâ ra r·∫±ng service c·ªßa ch√∫ng ta c√≥ ph·∫£i l√† primary hay kh√¥ng. N·∫øu kh√¥ng, service c·ªßa ch√∫ng ta s·∫Ω kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y khi ·ª©ng d·ª•ng ·ªü background.</li>
</ul>
<p>L∆∞u √Ω r·∫±ng b·∫°n c√≥ th·ªÉ th√™m bao nhi√™u service t√πy th√≠ch. ƒê·ªÉ ƒë∆°n gi·∫£n, t√¥i ch·ªâ t·∫°o m·ªôt service trong b√†i vi·∫øt n√†y.<br>OK, h√£y chuy·ªÉn sang b∆∞·ªõc ti·∫øp theo. Ch√∫ng ta s·∫Ω ƒë·ªãnh nghƒ©a c√°c characteristic cho service b·∫±ng code d∆∞·ªõi ƒë√¢y.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> characteristic = <span class="type">CBMutableCharacteristic</span>.<span class="keyword">init</span>(</span><br><span class="line">    type: <span class="type">CBUUID</span>(string: kCharacteristicUUID), [<span class="number">1</span>]</span><br><span class="line">    properties: [.read, .write, .notify], [<span class="number">2</span>]</span><br><span class="line">    value: <span class="literal">nil</span>, [<span class="number">3</span>]</span><br><span class="line">    permissions: [<span class="type">CBAttributePermissions</span>.readable, <span class="type">CBAttributePermissions</span>.writeable]) [<span class="number">4</span>]</span><br></pre></td></tr></table></figure>

<p>ƒê√¢y l√† nh·ªØng g√¨ ƒëang x·∫£y ra:</p>
<ul>
<li>[1] Gi·ªëng nh∆∞ service, m·ªôt characteristic c≈©ng c·∫ßn m·ªôt uuid duy nh·∫•t ƒë·ªÉ ƒë∆∞·ª£c ph√¢n bi·ªát v·ªõi c√°c characteristic kh√°c.</li>
<li>[2] Ch√∫ng ta thi·∫øt l·∫≠p c√°c thu·ªôc t√≠nh cho char. C√≥ nhi·ªÅu lo·∫°i permission cho characteristic, nh∆∞ng t√¥i th∆∞·ªùng s·ª≠ d·ª•ng m·ªôt s·ªë trong s·ªë ch√∫ng:<ul>
<li><em>Read</em>: ƒê∆∞·ª£c s·ª≠ d·ª•ng cho c√°c characteristic kh√¥ng thay ƒë·ªïi th∆∞·ªùng xuy√™n, v√≠ d·ª• s·ªë phi√™n b·∫£n.</li>
<li><em>Write</em>: S·ª≠a ƒë·ªïi gi√° tr·ªã c·ªßa characteristic.</li>
<li><em>Indicate v√† notify</em>: Peripheral li√™n t·ª•c th√¥ng b√°o gi√° tr·ªã c·∫≠p nh·∫≠t c·ªßa characteristic cho central. Central kh√¥ng ph·∫£i li√™n t·ª•c y√™u c·∫ßu n√≥.</li>
<li><em>IndicateEncryptionRequired</em>: Ch·ªâ c√°c thi·∫øt b·ªã ƒë√°ng tin c·∫≠y m·ªõi c√≥ th·ªÉ b·∫≠t indication c·ªßa gi√° tr·ªã characteristic.<br>ƒê·ªëi v·ªõi c√°c thu·ªôc t√≠nh kh√°c, vui l√≤ng tham kh·∫£o <a href="https://developer.apple.com/documentation/corebluetooth/cbcharacteristicproperties">t√†i li·ªáu Apple</a></li>
</ul>
</li>
<li>[3] Gi√° tr·ªã c·ªßa characteristic.</li>
</ul>
<p><em>L∆∞u √Ω quan tr·ªçng:</em> N·∫øu b·∫°n cung c·∫•p m·ªôt gi√° tr·ªã cho characteristic, characteristic ph·∫£i l√† read-only. N·∫øu kh√¥ng, b·∫°n s·∫Ω g·∫∑p exception run-time nh∆∞ sau.<br><code>2018-03-03 12:48:32.938615+0700 Peripheral[4238:3046876] *** Terminating app due to uncaught exception &#39;NSInternalInconsistencyException&#39;, reason: &#39;Characteristics with cached values must be read-only&#39;</code><br>Do ƒë√≥, b·∫°n ph·∫£i ch·ªâ ƒë·ªãnh gi√° tr·ªã l√† nil n·∫øu b·∫°n mong ƒë·ª£i gi√° tr·ªã thay ƒë·ªïi trong su·ªët th·ªùi gian t·ªìn t·∫°i c·ªßa service ƒë√£ publish (write).</p>
<ul>
<li>[4] T·∫•t c·∫£ characteristic n√™n bao g·ªìm permission ‚Äúreadable‚Äù ƒë·ªÉ c√°c central c√≥ th·ªÉ ƒë·ªçc gi√° tr·ªã c·ªßa n√≥. N·∫øu ch√∫ng ta mu·ªën central c√≥ th·ªÉ g·ª≠i l·ªánh ƒë·∫øn peripheral, ch√∫ng ta c·∫ßn ƒë·∫∑t permission ‚Äúwriteable‚Äù cho characteristic.</li>
</ul>
<p>B√¢y gi·ªù ch√∫ng ta c√≥ m·ªôt service v√† m·ªôt characteristic. H√£y publish n√≥.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.service?.characteristics = []</span><br><span class="line"><span class="keyword">self</span>.service?.characteristics?.append(characteristic)</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.peripheralManager.add(<span class="keyword">self</span>.service!)</span><br></pre></td></tr></table></figure>

<p>Sau khi th√™m m·ªôt service v√†o peripheral manager, delegate method <code>peripheralManager(_ peripheral: CBPeripheralManager, didAdd service: CBService, error: Error?)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheralManager</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheralManager, didAdd service: CBService, error: Error?)</span></span> &#123;</span><br><span class="line">     <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Add service failed: \(error.localizedDescription)"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Add service succeeded"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ch√∫ng ta g·∫ßn xong r·ªìi, ch·ªâ c√≤n m·ªôt b∆∞·ªõc n·ªØa: B·∫Øt ƒë·∫ßu advertising peripheral ƒë·ªÉ n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c t√¨m th·∫•y b·ªüi c√°c central kh√°c.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">peripheralManager.startAdvertising([<span class="type">CBAdvertisementDataLocalNameKey</span>: <span class="string">"TiTan"</span>,</span><br><span class="line">                                    <span class="type">CBAdvertisementDataServiceUUIDsKey</span> : [<span class="keyword">self</span>.service!.uuid]])</span><br></pre></td></tr></table></figure>

<p>Sau khi advertising, delegate method <code>peripheralManagerDidStartAdvertising</code> s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t ƒë·ªÉ ch·ªâ ra li·ªáu peripheral ƒë√£ advertising th√†nh c√¥ng hay ch∆∞a.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheralManagerDidStartAdvertising</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheralManager, error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Start advertising failed: \(error.localizedDescription)"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Start advertising succeeded"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>T·∫°i th·ªùi ƒëi·ªÉm n√†y, ch√∫ng ta ƒë√£ ƒë·ªãnh nghƒ©a v√† publish c√°c service c·ªßa m√¨nh. T·ª´ b√¢y gi·ªù, peripheral c√≥ th·ªÉ ƒë∆∞·ª£c kh√°m ph√° b·ªüi c√°c central th√¥ng qua CoreBluetooth.</p>
<p><img src="/Post-Resources/PlayRolesInCoreBluetooth/Peripheral_Result.png" alt=""></p>
<h2 id="Thiet-lap-Central"><a href="#Thiet-lap-Central" class="headerlink" title="Thi·∫øt l·∫≠p Central"></a>Thi·∫øt l·∫≠p Central</h2><p>ƒê·∫ßu ti√™n, ch√∫ng ta c·∫ßn t·∫°o m·ªôt instance c·ªßa class <code>CBCentralManager</code>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span>, <span class="title">CBCentralManagerDelegate</span>, <span class="title">UITableViewDelegate</span>, <span class="title">UITableViewDataSource</span>, <span class="title">CBPeripheralDelegate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">        centralManager = <span class="type">CBCentralManager</span>(delegate: <span class="keyword">self</span>, queue: <span class="literal">nil</span>)</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Gi·ªëng nh∆∞ peripheral manager, c√≥ m·ªôt tham s·ªë <code>queue</code> trong constructor. C√°c event c·ªßa vai tr√≤ central s·∫Ω ƒë∆∞·ª£c dispatch tr√™n queue ƒë∆∞·ª£c cung c·∫•p. N·∫øu ch√∫ng ta truy·ªÅn <code>nil</code>, main queue s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.<br>Ch√∫ng ta c·∫ßn ƒë·ª£i central manager s·∫µn s√†ng, sau ƒë√≥ ch√∫ng ta s·∫Ω b·∫Øt ƒë·∫ßu scan c√°c thi·∫øt b·ªã g·∫ßn ƒë√≥.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">centralManagerDidUpdateState</span><span class="params">(<span class="number">_</span> central: CBCentralManager)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"peripheralManagerDidUpdateState \(central.state.rawValue)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> central.state == .poweredOn &#123;</span><br><span class="line">        <span class="keyword">self</span>.centralManager.scanForPeripherals(withServices: <span class="literal">nil</span>, options: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>N·∫øu n√≥ t√¨m th·∫•y m·ªôt peripheral, delegate method <code>func centralManager(_ central: CBCentralManager, didDiscover peripheral: CBPeripheral, advertisementData: [String : Any], rssi RSSI: NSNumber)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">centralManager</span><span class="params">(<span class="number">_</span> central: CBCentralManager, didDiscover peripheral: CBPeripheral, advertisementData: [String : <span class="keyword">Any</span>], rssi RSSI: NSNumber)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> name = peripheral.name &#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkIfExisted(name)) &#123;</span><br><span class="line">            <span class="keyword">let</span> tupleDeviceInfo = (device: peripheral, rssi: <span class="type">RSSI</span>)</span><br><span class="line">            <span class="keyword">self</span>.scannedDevices.append(tupleDeviceInfo)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="keyword">self</span>.tbvScannedDevices.reloadData()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>B√™n trong method, ch√∫ng ta s·∫Ω ki·ªÉm tra xem peripheral c√≥ h·ª£p l·ªá kh√¥ng, sau ƒë√≥ ch√∫ng ta s·∫Ω th√™m n√≥ v√†o danh s√°ch hi·ªán t·∫°i, r·ªìi reload table view. L∆∞u √Ω r·∫±ng gi√° tr·ªã RSSI ƒë·∫°i di·ªán cho c∆∞·ªùng ƒë·ªô c·ªßa t√≠n hi·ªáu truy·ªÅn. Ch√∫ng ta c√≥ th·ªÉ ∆∞·ªõc t√≠nh kho·∫£ng c√°ch hi·ªán t·∫°i gi·ªØa central v√† peripheral d·ª±a tr√™n gi√° tr·ªã n√†y. Gi√° tr·ªã c√†ng l·ªõn, thi·∫øt b·ªã c√†ng g·∫ßn.<br>Build v√† ch·∫°y project, b·∫°n s·∫Ω th·∫•y danh s√°ch c√°c thi·∫øt b·ªã ƒë∆∞·ª£c ph√°t hi·ªán nh∆∞ th·∫ø n√†y.</p>
<img src="/Post-Resources/PlayRolesInCoreBluetooth/Scan_Devices.png" height="500" />

<p>B√¢y gi·ªù, h√£y k·∫øt n·ªëi v·ªõi peripheral c·ªßa ch√∫ng ta (Thi·∫øt b·ªã ‚ÄúTitan‚Äù) b·∫±ng c√°ch click v√†o h√†ng t∆∞∆°ng ·ª©ng.<br>Khi m·ªôt k·∫øt n·ªëi ƒë∆∞·ª£c th·ª±c hi·ªán th√†nh c√¥ng, delegate method <code>func centralManager(_ central: CBCentralManager, didConnect peripheral: CBPeripheral)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi. N·∫øu kh√¥ng, method <code>centralManager(_ central: CBCentralManager, didFailToConnect peripheral: CBPeripheral, error: Error?)</code> s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">centralManager</span><span class="params">(<span class="number">_</span> central: CBCentralManager, didConnect peripheral: CBPeripheral)</span></span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.centralManager.stopScan()</span><br><span class="line">    peripheral.delegate = <span class="keyword">self</span></span><br><span class="line">    <span class="keyword">self</span>.peripheral = peripheral</span><br><span class="line">    <span class="keyword">self</span>.peripheral?.discoverServices(<span class="literal">nil</span>) [<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">centralManager(<span class="number">_</span> central: <span class="type">CBCentralManager</span>, didFailToConnect peripheral: <span class="type">CBPeripheral</span>, error: <span class="type">Error?</span>) &#123;</span><br><span class="line">    <span class="comment">// Fail to connect peripheral</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>L∆∞u √Ω r·∫±ng sau khi k·∫øt n·ªëi v·ªõi peripheral, ch√∫ng ta c·∫ßn discover c√°c service c·ªßa peripheral ƒë·ªÉ s·ª≠ d·ª•ng n√≥ ([1]).<br>Delegate method <code>func peripheral(_ peripheral: CBPeripheral, didDiscoverServices error: Error?)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi sau khi discovering services.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheral</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheral, didDiscoverServices error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> err = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"didDiscoverServices fail \(err.localizedDescription)"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [1] Start discovering all chars</span></span><br><span class="line">    <span class="keyword">for</span> service <span class="keyword">in</span> (peripheral.services)! &#123;</span><br><span class="line">        peripheral.discoverCharacteristics(<span class="literal">nil</span>, <span class="keyword">for</span>: service)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ch√∫ng ta v·∫´n ch∆∞a xong =.= Sau khi discovering services, ch√∫ng ta c≈©ng c·∫ßn discover t·∫•t c·∫£ c√°c characteristic c·ªßa c√°c service t·∫°i [1].<br>Gi·ªëng nh∆∞ c√°c method kh√°c, method <code>func peripheral(_ peripheral: CBPeripheral, didDiscoverCharacteristicsFor service: CBService, error: Error?)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi sau khi discovering characteristics cho m·ªôt service.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheral</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheral, didDiscoverCharacteristicsFor service: CBService, error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"didDiscoverCharacteristicsFor Error \(error.localizedDescription)"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> service.characteristics! &#123;</span><br><span class="line">        <span class="keyword">if</span> char.properties.<span class="built_in">contains</span>(.notify) &#123;</span><br><span class="line">            peripheral.setNotifyValue(<span class="literal">true</span>, <span class="keyword">for</span>: char) [<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nh∆∞ b·∫°n th·∫•y, ch√∫ng ta c·∫ßn ƒë·∫∑t notify cho characteristic ch·ª©a thu·ªôc t√≠nh <code>notify</code> ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t t·ª´ n√≥. [1]<br>Cu·ªëi c√πng, ch√∫ng ta ƒë√£ ho√†n th√†nh vi·ªác thi·∫øt l·∫≠p k·∫øt n·ªëi gi·ªØa peripheral v√† central. B√¢y gi·ªù h√£y kh√°m ph√° d·ªØ li·ªáu.</p>
<h2 id="Doc-va-ghi-du-lieu-tu-peripheral"><a href="#Doc-va-ghi-du-lieu-tu-peripheral" class="headerlink" title="ƒê·ªçc v√† ghi d·ªØ li·ªáu t·ª´ peripheral"></a>ƒê·ªçc v√† ghi d·ªØ li·ªáu t·ª´ peripheral</h2><p>B·∫°n ph·∫£i ch·ªâ ƒë·ªãnh characteristic n√†o b·∫°n mu·ªën ƒë·ªçc.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.peripheral?.readValue(<span class="keyword">for</span>: discovererChars[kCharacteristicUUID]!)</span><br></pre></td></tr></table></figure>
<p>T·ª´ ph√≠a peripheral, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt read request b√™n trong method</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheralManager</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheralManager, didReceiveRead request: CBATTRequest)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Read request"</span>)</span><br><span class="line">    request.value = myValue.data(using: .utf8)</span><br><span class="line">    peripheral.respond(to: request, withResult: .success)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Sau khi peripheral ph·∫£n h·ªìi c√°c read request, delegate method <code>func peripheral(_ peripheral: CBPeripheral, didUpdateValueFor characteristic: CBCharacteristic, error: Error?)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi t·ª´ ph√≠a central.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">peripheral</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheral, didUpdateValueFor characteristic: CBCharacteristic, error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="type">String</span>.<span class="keyword">init</span>(data: characteristic.value!, encoding: .utf8)!</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>N·∫øu gi√° tr·ªã ƒë∆∞·ª£c l·∫•y th√†nh c√¥ng, b·∫°n c√≥ th·ªÉ truy c·∫≠p n√≥ th√¥ng qua thu·ªôc t√≠nh value c·ªßa characteristic, nh∆∞ tr√™n.<br>ƒê√¥i khi ch√∫ng ta mu·ªën ghi gi√° tr·ªã c·ªßa m·ªôt characteristic c√≥ th·ªÉ ghi ƒë∆∞·ª£c. Ch√∫ng ta c√≥ th·ªÉ ghi gi√° tr·ªã v√†o n√≥ b·∫±ng c√°ch g·ªçi method <code>writeValue</code> c·ªßa peripheral nh∆∞ th·∫ø n√†y.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.peripheral?.writeValue(data, <span class="keyword">for</span>: discovererChars[kCharacteristicUUID]!, type: .withResponse)</span><br></pre></td></tr></table></figure>
<p>C√≥ m·ªôt argument g·ªçi l√† <code>type</code>, b·∫°n ch·ªâ ƒë·ªãnh lo·∫°i write b·∫°n mu·ªën th·ª±c hi·ªán. Trong v√≠ d·ª• tr√™n, lo·∫°i write l√† .withResponse, y√™u c·∫ßu peripheral cho ·ª©ng d·ª•ng c·ªßa b·∫°n bi·∫øt li·ªáu vi·ªác write c√≥ th√†nh c√¥ng hay kh√¥ng.<br>T·ª´ ph√≠a peripheral, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt write request b√™n trong method</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheralManager</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheralManager, didReceiveWrite requests: [CBATTRequest])</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Write request"</span>)</span><br><span class="line">    peripheral.respond(to: requests[<span class="number">0</span>], withResult: .success)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Sau khi write request nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi, method <code>peripheral(_ peripheral: CBPeripheral, didWriteValueFor characteristic: CBCharacteristic, error: Error?)</code> s·∫Ω ƒë∆∞·ª£c g·ªçi.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">peripheral</span><span class="params">(<span class="number">_</span> peripheral: CBPeripheral, didWriteValueFor characteristic: CBCharacteristic, error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> err = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Did write value with error \(err.localizedDescription)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Gia-tri-characteristic-duoc-ma-hoa"><a href="#Gia-tri-characteristic-duoc-ma-hoa" class="headerlink" title="Gi√° tr·ªã characteristic ƒë∆∞·ª£c m√£ h√≥a"></a>Gi√° tr·ªã characteristic ƒë∆∞·ª£c m√£ h√≥a</h2><p>ƒê√¥i khi ch√∫ng ta mu·ªën b·∫£o m·∫≠t d·ªØ li·ªáu nh·∫°y c·∫£m. Ch√∫ng ta c√≥ th·ªÉ c·∫•u h√¨nh c√°c thu·ªôc t√≠nh v√† permission characteristic ph√π h·ª£p. Nh∆∞ th·∫ø n√†y</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> encryptedChar = <span class="type">CBMutableCharacteristic</span>.<span class="keyword">init</span>(</span><br><span class="line">                type: <span class="type">CBUUID</span>(string: kCharacteristicUUID),</span><br><span class="line">                properties: [.read, .notify, .notifyEncryptionRequired],</span><br><span class="line">                value: <span class="literal">nil</span>,</span><br><span class="line">                permissions: [.readable])</span><br></pre></td></tr></table></figure>

<p>B·∫±ng c√°ch n√†y, ch√∫ng ta ƒë·∫£m b·∫£o r·∫±ng ch·ªâ c√°c thi·∫øt b·ªã ƒë√°ng tin c·∫≠y m·ªõi c√≥ quy·ªÅn truy c·∫≠p v√†o c√°c d·ªØ li·ªáu n√†y.<br>Trong v√≠ d·ª• c·ªßa t√¥i, m·ªôt khi k·∫øt n·ªëi ƒë∆∞·ª£c th·ª±c hi·ªán, CoreBluetooth c·ªë g·∫Øng gh√©p n·ªëi peripheral (iPad) v·ªõi central (iPhone) ƒë·ªÉ t·∫°o k·∫øt n·ªëi an to√†n. C·∫£ hai thi·∫øt b·ªã s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt c·∫£nh b√°o ch·ªâ ra r·∫±ng thi·∫øt b·ªã kia mu·ªën gh√©p n·ªëi. Sau khi gh√©p n·ªëi, central c√≥ th·ªÉ truy c·∫≠p c√°c gi√° tr·ªã characteristic ƒë∆∞·ª£c m√£ h√≥a c·ªßa peripheral.</p>
<img src="/Post-Resources/PlayRolesInCoreBluetooth/Paring_Request.png" height="200" />

<h2 id="Mot-so-luu-y-quan-trong"><a href="#Mot-so-luu-y-quan-trong" class="headerlink" title="M·ªôt s·ªë l∆∞u √Ω quan tr·ªçng"></a>M·ªôt s·ªë l∆∞u √Ω quan tr·ªçng</h2><ul>
<li>M√¥ h√¨nh client-server c·ªßa BLE ƒë∆∞·ª£c g·ªçi l√† <em>m√¥ h√¨nh publish v√† subscribe</em>.</li>
<li>Peripheral ch·ªâ ti√™u th·ª• nƒÉng l∆∞·ª£ng khi n√≥ ƒëang advertising c√°c service c·ªßa m√¨nh, ho·∫∑c nh·∫≠n ho·∫∑c ph·∫£n h·ªìi y√™u c·∫ßu c·ªßa central.</li>
<li>B·∫°n c√≥ th·ªÉ truy·ªÅn m·ªôt danh s√°ch c√°c service UUID b√™n trong method <code>scanForPeripherals</code>. Khi b·∫°n ch·ªâ ƒë·ªãnh m·ªôt danh s√°ch c√°c service UUID, central manager ch·ªâ tr·∫£ v·ªÅ c√°c peripheral advertising nh·ªØng service ƒë√≥, cho ph√©p b·∫°n ch·ªâ scan c√°c thi·∫øt b·ªã m√† b·∫°n c√≥ th·ªÉ quan t√¢m.</li>
<li>B·∫°n c·∫ßn c·∫•p quy·ªÅn ƒë·ªÉ cho ph√©p ·ª©ng d·ª•ng c·ªßa b·∫°n s·ª≠ d·ª•ng ph·ª• ki·ªán Bluetooth LE, v√† ho·∫°t ƒë·ªông nh∆∞ m·ªôt ph·ª• ki·ªán Bluetooth LE cho ph√≠a peripheral. (ƒêi ƒë·∫øn project -&gt; Capabilities ƒë·ªÉ thi·∫øt l·∫≠p).</li>
<li>B·∫°n c≈©ng c·∫ßn th√™m m·ªôt thu·ªôc t√≠nh th√¥ng tin n·ªØa v√†o info.plist c·ªßa b·∫°n, h√£y th√™m m·ªôt entry v·ªõi key <code>Privacy - Bluetooth Peripheral Usage Description</code> v√† value <code>App communicates using CoreBluetooth</code> (Ho·∫∑c b·∫•t c·ª© ƒëi·ªÅu g√¨ b·∫°n mu·ªën m√¥ t·∫£).</li>
</ul>
<h2 id="Xem-nhanh-ung-dung-cua-toi"><a href="#Xem-nhanh-ung-dung-cua-toi" class="headerlink" title="Xem nhanh ·ª©ng d·ª•ng c·ªßa t√¥i"></a>Xem nhanh ·ª©ng d·ª•ng c·ªßa t√¥i</h2><p>H√£y th·ª≠ m·ªôt s·ªë b√†i t·∫≠p nh·∫π t·ª´ v√≠ d·ª• c·ªßa t√¥i.<br><img src="/Post-Resources/PlayRolesInCoreBluetooth/Demo.gif" height="500" /></p>
<h2 id="Tom-tat-luong-lap-trinh-cho-BLE"><a href="#Tom-tat-luong-lap-trinh-cho-BLE" class="headerlink" title="T√≥m t·∫Øt lu·ªìng l·∫≠p tr√¨nh cho BLE"></a>T√≥m t·∫Øt lu·ªìng l·∫≠p tr√¨nh cho BLE</h2><p>ƒê·ªÉ t√≥m t·∫Øt quy tr√¨nh l·∫≠p tr√¨nh chung c·ªßa CoreBluetooth tr√™n iOS, vui l√≤ng xem h√¨nh ·∫£nh d∆∞·ªõi ƒë√¢y.</p>
<p><img src="/Post-Resources/PlayRolesInCoreBluetooth/Programming_Flow_BLE.png" alt=""></p>
<h2 id="Suy-nghi-cuoi-cung"><a href="#Suy-nghi-cuoi-cung" class="headerlink" title="Suy nghƒ© cu·ªëi c√πng"></a>Suy nghƒ© cu·ªëi c√πng</h2><p>Trong b√†i vi·∫øt n√†y, t√¥i ƒë√£ h∆∞·ªõng d·∫´n b·∫°n c√°ch s·ª≠ d·ª•ng CoreBluetooth ƒë·ªÉ t·∫°o m·ªôt peripheral c≈©ng nh∆∞ c√°ch t·∫°o m·ªôt central ƒë·ªÉ k·∫øt n·ªëi v√† l·∫•y d·ªØ li·ªáu t·ª´ peripheral. Trong t∆∞∆°ng lai, ch√∫ng ta c√≥ th·ªÉ th·∫•y r·∫±ng t·∫•t c·∫£ c√°c thi·∫øt b·ªã xung quanh ch√∫ng ta ƒë∆∞·ª£c k·∫øt n·ªëi v·ªõi nhau th√¥ng qua Bluetooth, h∆∞·ªõng t·ªõi th·∫ø gi·ªõi IoT.<br>B·∫°n c√≥ th·ªÉ t·∫£i project ho√†n ch·ªânh c·ªßa central <a href="https://github.com/uynguyen/CoreBluetooth_CentralManager">t·∫°i ƒë√¢y</a> ho·∫∑c peripheral <a href="https://github.com/uynguyen/Blog_CoreBluetooth_Peripheral">t·∫°i ƒë√¢y</a>.<br>N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ c√¢u h·ªèi ho·∫∑c b√¨nh lu·∫≠n n√†o, h√£y tho·∫£i m√°i ƒë·ªÉ l·∫°i tr√™n b√†i vi·∫øt c·ªßa t√¥i. M·ªçi b√¨nh lu·∫≠n ƒë·ªÅu ƒë∆∞·ª£c ch√†o ƒë√≥n.</p>
<h2 id="Tai-lieu-tham-khao"><a href="#Tai-lieu-tham-khao" class="headerlink" title="T√†i li·ªáu tham kh·∫£o"></a>T√†i li·ªáu tham kh·∫£o</h2><p>[1] <a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html#//apple_ref/doc/uid/TP40013257-CH1-SW1">Core Bluetooth Programming Guide t·ª´ Apple</a></p>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/"></a><a class="link-muted mr-2" rel="tag" href="/"></a><a class="link-muted mr-2" rel="tag" href="/"></a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5e9474199d6bcc0012d5bba6&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="https://ko-fi.com/uynguyen" style="background-color:rgba(255,128,62,.87);border-color:transparent;color:white;" target="_blank" rel="noopener"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button is-warning donate" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="uynguyen.itus@gmail.com"><input type="hidden" name="currency_code" value="USD"></form></div></div></div><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://uynguyen.github.io/vi/posts/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/index.html';
            this.page.identifier = 'vi/posts/Play-Central-And-Peripheral-Roles-With-CoreBluetooth/index.html';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'uynguyen-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen"></figure><p class="title is-size-4 is-block line-height-inherit">Uy Nguyen</p><p class="is-size-6 is-block">Software engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-envelope mr-1"></i><span>uynguyen.itus@gmail.com</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">58</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-rounded" style="background-color:#f14668e3;color:white;font-weight:bold;" href="https://ko-fi.com/uynguyen" target="_blank" rel="noopener">if üëç then Buy me a Coffee</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/uynguyen"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://www.linkedin.com/in/uynguyen505"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://uynguyen.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Uy Nguyen</span></span><span class="level-right"><span class="level-item tag">uynguyen.github.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recent</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2025-04-02T11:03:38.000Z">2025-04-02</time></p><p class="title is-6"><a class="link-muted" href="/2025/04/02/Bluetooth-security-Implement-authentication/">Securing Bluetooth Communication: Implementing Authentication and Encryption Flows</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-11-03T03:33:53.000Z">2024-11-03</time></p><p class="title is-6"><a class="link-muted" href="/2024/11/03/iOS-18-What-s-news-in-CoreBluetooth/">iOS 18: What&#039;s news in CoreBluetooth?</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-31T03:38:32.000Z">2024-08-31</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/31/Bluetooth-security-Pairing-and-Bonding/">Bluetooth security: Pairing and Bonding</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-04T05:10:39.000Z">2024-08-04</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/04/Android-Bluetooth-A-Pitfall/">Android Bluetooth: A Pitfall</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-06-30T03:48:09.000Z">2024-06-30</time></p><p class="title is-6"><a class="link-muted" href="/2024/06/30/Best-practice-iOS-vs-Android-Bluetooth/">Best practice: iOS vs Android Bluetooth</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Appclip/"><span class="tag">Appclip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLE/"><span class="tag">BLE</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bluetooth/"><span class="tag">Bluetooth</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Books/"><span class="tag">Books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocoa/"><span class="tag">Cocoa</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Concurrency/"><span class="tag">Concurrency</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Conference/"><span class="tag">Conference</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Core-Data/"><span class="tag">Core Data</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CoreBluetooh/"><span class="tag">CoreBluetooh</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CrossPlatform/"><span class="tag">CrossPlatform</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Design-Patterns/"><span class="tag">Design Patterns</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DispatchQueue/"><span class="tag">DispatchQueue</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Memory-management/"><span class="tag">Memory management</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Notification/"><span class="tag">Notification</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Objective-C/"><span class="tag">Objective-C</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operations/"><span class="tag">Operations</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ReactNative/"><span class="tag">ReactNative</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Software-Architecture/"><span class="tag">Software Architecture</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Study/"><span class="tag">Study</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UI/"><span class="tag">UI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UIStackView/"><span class="tag">UIStackView</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UML/"><span class="tag">UML</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vendor/"><span class="tag">Vendor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WatchOS/"><span class="tag">WatchOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Web-Bluetooth/"><span class="tag">Web Bluetooth</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/books/"><span class="tag">books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iBeacon/"><span class="tag">iBeacon</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/study/"><span class="tag">study</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a><p class="size-small"><span>&copy; Uy Nguyen</span>¬†¬†Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>¬†&amp;¬†<a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("vi");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://uynguyen.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">√ó</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>