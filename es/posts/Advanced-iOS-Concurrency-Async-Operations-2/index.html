<!doctype html>
<html lang="es"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Concurrencia Avanzada en iOS: Operaciones As√≠ncronas [2] - Uy Nguyen</title><meta description="En la publicaci√≥n anterior, Concurrencia Avanzada en iOS: Operations, revisamos los conceptos de Operation en iOS e hicimos una aplicaci√≥n de demostraci√≥n que obtiene algunas de mis publicaciones. De"><meta property="og:type" content="blog"><meta property="og:title" content="Concurrencia Avanzada en iOS: Operaciones As√≠ncronas [2]"><meta property="og:url" content=":year/:month/:day/:title/"><meta property="og:site_name" content="Uy Nguyen"><meta property="og:description" content="En la publicaci√≥n anterior, Concurrencia Avanzada en iOS: Operations, revisamos los conceptos de Operation en iOS e hicimos una aplicaci√≥n de demostraci√≥n que obtiene algunas de mis publicaciones. De"><meta property="og:locale" content="es_ES"><meta property="article:published_time" content="2020-05-30T10:02:31.000Z"><meta property="article:modified_time" content="2026-01-26T06:49:48.811Z"><meta property="article:author" content="Uy Nguyen"><meta property="article:tag" content="Concurrency"><meta property="article:tag" content="Operations"><meta property="article:tag" content="iOS"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/Post-Resources/Operations_2/operations.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://uynguyen.github.io/es/posts/Advanced-iOS-Concurrency-Async-Operations-2/index.html"},"headline":"Uy Nguyen","image":["https://uynguyen.github.io/Post-Resources/Operations_2/operations.png","https://uynguyen.github.io/Post-Resources/Operations_2/Async_Operation_State.png","https://uynguyen.github.io/Post-Resources/Operations_2/final.gif"],"datePublished":"2020-05-30T10:02:31.000Z","dateModified":"2026-01-26T06:49:48.811Z","author":{"@type":"Person","name":"Uy Nguyen"},"description":"En la publicaci√≥n anterior, Concurrencia Avanzada en iOS: Operations, revisamos los conceptos de Operation en iOS e hicimos una aplicaci√≥n de demostraci√≥n que obtiene algunas de mis publicaciones. De"}</script><link rel="canonical" href="https://uynguyen.github.io/es/posts/Advanced-iOS-Concurrency-Async-Operations-2/index.html"><link rel="icon" href="/Post-Resources/UyNguyen.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><meta property="og:image" content="/Post-Resources/Operations_2/operations.png"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-163508356-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-163508356-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><div class="navbar-item has-dropdown is-hoverable language-switcher is-hidden-mobile"><a class="navbar-link" title="Idioma"><i class="fas fa-globe"></i></a><div class="navbar-dropdown is-right"><a class="navbar-item" href="/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/">English</a><a class="navbar-item" href="/vi/posts/Advanced-iOS-Concurrency-Async-Operations-2/">Ti·∫øng Vi·ªát</a><a class="navbar-item is-active" href="/es/posts/Advanced-iOS-Concurrency-Async-Operations-2/">Espa√±ol</a></div></div><a class="navbar-item search is-hidden-mobile" title="Buscar" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><div class="mobile-toolbar is-hidden-tablet"><div class="container"><div class="mobile-toolbar-content"><button class="mobile-toolbar-btn" id="mobile-lang-btn" title="Idioma"><i class="fas fa-globe"></i><span>Espa√±ol</span></button><button class="mobile-toolbar-btn search" title="Buscar"><i class="fas fa-search"></i><span>Buscar</span></button></div></div></div><div class="language-picker-overlay" id="lang-picker-overlay"><div class="language-picker-backdrop"></div><div class="language-picker-modal"><div class="language-picker-header"><span>Idioma</span><button class="language-picker-close" id="lang-picker-close"><i class="fas fa-times"></i></button></div><div class="language-picker-options"><a class="language-picker-option" href="/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/"><span class="lang-name">English</span></a><a class="language-picker-option" href="/vi/posts/Advanced-iOS-Concurrency-Async-Operations-2/"><span class="lang-name">Ti·∫øng Vi·ªát</span></a><a class="language-picker-option is-active" href="/es/posts/Advanced-iOS-Concurrency-Async-Operations-2/"><span class="lang-name">Espa√±ol</span><i class="fas fa-check"></i></a></div></div></div><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"></div></div><h1 class="title is-3 is-size-4-mobile">Concurrencia Avanzada en iOS: Operaciones As√≠ncronas [2]</h1><div class="content"><p><img src="/Post-Resources/Operations_2/operations.png" alt="" title="Operations"></p>
<p>En la publicaci√≥n anterior, <a href="/2020/05/16/iOS-Concurrency-Operations">Concurrencia Avanzada en iOS: Operations</a>, revisamos los conceptos de Operation en iOS e hicimos una aplicaci√≥n de demostraci√≥n que obtiene algunas de mis publicaciones. Despu√©s de descargar las im√°genes de portada, se les aplicar√° un filtro simple y luego se mostrar√°n en una tabla. Sin embargo, la aplicaci√≥n a√∫n no est√° completa. Hay algo que sali√≥ mal con nuestra aplicaci√≥n que hace que no muestre las im√°genes descargadas correctamente. En este tutorial, continuaremos donde lo dejamos.<br>¬°Prep√°rate!</p>
<a id="more"></a>
<h2 id="Ciclo-de-vida-de-Operation"><a href="#Ciclo-de-vida-de-Operation" class="headerlink" title="Ciclo de vida de Operation"></a>Ciclo de vida de Operation</h2><p>Para descubrir por qu√© nuestra aplicaci√≥n no funcion√≥ correctamente, revisemos el c√≥digo fuente actual</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadImageOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> !isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">URLSession</span>.shared.dataTask(with: <span class="keyword">self</span>.url, completionHandler: &#123; (data, res, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span>,</span><br><span class="line">                <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.outputImage = <span class="type">UIImage</span>(data: data)</span><br><span class="line">        &#125;).resume()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>La siguiente imagen describe los cambios en los estados de las operaciones.<br><img src="/Post-Resources/Operations_2/Async_Operation_State.png" alt="" title="Async_Operation_State"></p>
<p>Cuando se llama al m√©todo <code>main</code>, ejecutar√° nuestra tarea as√≠ncrona y luego saldr√° inmediatamente haciendo que el estado de la operaci√≥n cambie a <code>isFinish</code>. En ese momento, nuestra tarea as√≠ncrona en realidad a√∫n no ha completado.<br>Actualmente, estamos llamando para descargar una imagen dentro del m√©todo <code>main</code> de la Operation. La causa ra√≠z est√° relacionada con el Ciclo de Vida de Operation en s√≠. Por lo tanto, para soportar operaciones as√≠ncronas en nuestra aplicaci√≥n, necesitamos gestionar manualmente los estados de las operaciones.</p>
<h2 id="Key-Value-Observing"><a href="#Key-Value-Observing" class="headerlink" title="Key-Value Observing"></a><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Key-Value Observing</a></h2><p>Antes de implementar nuestra clase Async Operation personalizada, necesitamos aprender un nuevo concepto primero: KVO. Asumo que no has escuchado sobre este concepto, as√≠ que primero le daremos un vistazo r√°pido.<br>Key-Value Observing, tambi√©n conocido como KVO, es una de las t√©cnicas para observar los cambios de estado de un objeto en Objective-C y Swift. Cada vez que el valor de las propiedades observadas cambia, el bloque de c√≥digo de observaci√≥n se ejecutar√°. En el coraz√≥n de KVO, el concepto principal se basa en el Patr√≥n Observer.<br>Las clases Swift que heredan de la clase <code>NSObject</code> tienen m√©todos para permitir que otros objetos observen sus propiedades.</p>
<blockquote>
<p>Key-value observing proporciona un mecanismo que permite que los objetos sean notificados de cambios en propiedades espec√≠ficas de otros objetos. Es particularmente √∫til para la comunicaci√≥n entre las capas de modelo y controlador en una aplicaci√≥n.</p>
</blockquote>
<p>Creemos un Playground para probarlo.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditCard</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">dynamic</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> number: <span class="type">Int</span> = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">increaseNumber</span><span class="params">(by value: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.number += value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cretdit: <span class="type">CreditCard</span></span><br><span class="line">    <span class="keyword">var</span> kvoToken: <span class="type">NSKeyValueObservation?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(cretdit: <span class="type">CreditCard</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.cretdit = cretdit</span><br><span class="line">        kvoToken = <span class="keyword">self</span>.cretdit.observe(\.number, options: .new) &#123; (credit, change) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newNumber = change.newValue <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"New number is \(newNumber)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        kvoToken?.invalidate()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> credit = <span class="type">CreditCard</span>()</span><br><span class="line"><span class="keyword">let</span> person = <span class="type">Person</span>(cretdit: credit)</span><br><span class="line">credit.increaseNumber(by: <span class="number">500</span>)</span><br></pre></td></tr></table></figure>

<p>Aqu√≠, defino dos clases: <code>CreditCard</code> y <code>Person</code>. Un objeto <code>Person</code> tiene un objeto <code>CreditCard</code> como propiedad. Lo que quiero es que cada vez que la propiedad <code>number</code> de la tarjeta de cr√©dito cambie, la persona sea notificada. Aqu√≠ es donde entra KVO.<br>Ejecuta el c√≥digo anterior en el playground, deber√≠as ver el log <code>New number is \(newNumber)</code> impreso en tu consola.</p>
<p>¬øPor qu√© necesitamos saber sobre KVO? La respuesta es porque la clase Operation usa notificaciones KVO. Cada vez que el estado de Operation cambia, se enviar√° una notificaci√≥n KVO.<br>Sin las notificaciones KVO, el OperationQueue no podr√° observar el estado de nuestras operaciones por lo que no puede actualizarse correctamente. Por lo tanto, cuando gestionamos el estado de la operaci√≥n por nosotros mismos, debemos asegurarnos de que esas notificaciones KVO se env√≠en correctamente.</p>
<h2 id="Async-Operation"><a href="#Async-Operation" class="headerlink" title="Async Operation"></a>Async Operation</h2><p>Creemos la clase <code>AsyncOperation</code> heredada de la clase <code>Operation</code>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">State</span>: <span class="title">String</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> ready, executing, finished</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> keyPath: <span class="type">String</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"is\(rawValue.capitalized)"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// El resto del c√≥digo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A continuaci√≥n, declaramos una propiedad para rastrear el estado del objeto.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> state = <span class="type">State</span>.ready &#123;</span><br><span class="line">    <span class="keyword">willSet</span> &#123;</span><br><span class="line">        willChangeValue(forKey: newValue.keyPath)</span><br><span class="line">        willChangeValue(forKey: state.keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">        didChangeValue(forKey: oldValue.keyPath)</span><br><span class="line">        didChangeValue(forKey: state.keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>La clase base <code>Operation</code> necesita conocer los cambios tanto del estado antiguo como del nuevo estado.<br>Tomemos un caso espec√≠fico como ejemplo, el estado actualmente es <code>ready</code>, luego establecemos el estado a <code>executing</code>. Hay 4 notificaciones KVO que deben enviarse:</p>
<ul>
<li>Primero, notificar el willChangeValue para <code>isReady</code>.</li>
<li>Luego, notificar el willChangeValue para <code>executing</code>.</li>
<li>Despu√©s de eso, notificar el willChange para <code>isReady</code>.</li>
<li>Finalmente, notificar el willChange para <code>executing</code>.</li>
</ul>
<p>Despu√©s de eso, sobrescribimos las propiedades de estados.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isReady: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.isReady &amp;&amp; state == .ready</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isExecuting: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state == .executing</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isFinished: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state == .finished</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isAsynchronous: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Eso es todo para gestionar el estado de la clase Async Operation.</p>
<p>Cuando se agrega una operaci√≥n a una cola de operaciones, el m√©todo <code>start</code> es lo que se llama primero, luego llamar√° al m√©todo <code>main</code> de la operaci√≥n ejecutando el bloque principal de c√≥digo que has asignado a la operaci√≥n.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    main()</span><br><span class="line">    state = .executing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>¬øRecuerdas cuando mencion√© que Operation tiene caracter√≠sticas extraordinarias que lo hacen superar a GDC? La primera son las dependencias y la otra es la capacidad de cancelar una operaci√≥n en ejecuci√≥n. Es muy √∫til en un caso donde queremos detener operaciones que son irrelevantes en un momento determinado. Por ejemplo, cancelar la descarga de datos cuando el usuario hace scroll en la tabla haciendo que algunas celdas desaparezcan.<br>Agreguemos esta caracter√≠stica a nuestra clase Async Operation.<br>Primero, necesitamos modificar el m√©todo <code>start</code> para verificar la propiedad <code>isCancelled</code> antes de llamar realmente al m√©todo <code>main</code>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> isCancelled &#123;</span><br><span class="line">        state = .finished</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    main()</span><br><span class="line">    state = .executing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Y luego sobrescribir el m√©todo <code>cancel</code> para actualizar el estado a <code>finished</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    state = .finished</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>En este punto, hemos terminado de implementar nuestra clase <code>Async Operation</code>. Es hora de mezclar todo junto en nuestra aplicaci√≥n.</p>
<h2 id="Juntando-todo"><a href="#Juntando-todo" class="headerlink" title="Juntando todo"></a>Juntando todo</h2><p>Debido a que la clase <code>DownloadImageOperation</code> se ejecuta de forma as√≠ncrona, no podemos establecer la clase <code>Operation</code> como su clase base, ahora establecemos <code>AsyncOperation</code> en su lugar. Ten en cuenta que para soportar la cancelaci√≥n en la clase <code>DownloadImageOperation</code>, mantendremos el valor de retorno de crear una tarea de datos como una propiedad de esta clase para que podamos cancelar este <code>URLSessionDataTask</code> m√°s tarde.<br>La clase <code>DownloadImageOperation</code> se ver√° as√≠.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadImageOperation</span>: <span class="title">AsyncOperation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">URL</span></span><br><span class="line">    <span class="keyword">var</span> outputImage: <span class="type">UIImage?</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> task: <span class="type">URLSessionDataTask?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(url: <span class="type">URL</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.url = url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.task = <span class="type">URLSession</span>.shared.dataTask(with: <span class="keyword">self</span>.url, completionHandler: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] (data, res, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> `<span class="keyword">self</span>` = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">defer</span> &#123; <span class="keyword">self</span>.state = .finished &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">guard</span> !<span class="keyword">self</span>.isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span>,</span><br><span class="line">                <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.outputImage = <span class="type">UIImage</span>(data: data)</span><br><span class="line">        &#125;)</span><br><span class="line">        task?.resume()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.cancel()</span><br><span class="line">        task?.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Volvamos a nuestro <code>ViewController</code> principal. Para cancelar las operaciones en ejecuci√≥n, primero agregamos un nuevo diccionario como propiedad de <code>ViewController</code> que rastrea todas las operaciones en ejecuci√≥n para cada celda de la tabla en un index path correspondiente.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> operations: [<span class="type">IndexPath</span>: [<span class="type">Operation</span>]] = [:]</span><br></pre></td></tr></table></figure>

<p>Dentro del delegado <code>func tableView(_ tableView:cellForRowAt indexPath:)</code>, despu√©s de agregar dos operaciones a la cola de operaciones, tambi√©n las agregaremos al diccionario <code>operations</code> para rastrearlas. Adem√°s, si hay una operaci√≥n para este index path, la cancelamos antes de mantener la nueva.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> existingOperations = operations[indexPath] &#123;</span><br><span class="line">    <span class="keyword">for</span> operation <span class="keyword">in</span> existingOperations &#123;</span><br><span class="line">        operation.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">operations[indexPath] = [grayScaleOpt, downloadOpt]</span><br></pre></td></tr></table></figure>

<p>Cuando el usuario hace scroll en la tabla, algunas celdas desaparecen y se llama al delegado <code>func tableView(_ tableView:didEndDisplaying cell:indexPath:)</code>. En ese momento, tambi√©n cancelaremos las operaciones en ejecuci√≥n para esa celda asegur√°ndonos de que solo las operaciones de las celdas visibles se est√©n ejecutando.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didEndDisplaying cell: UITableViewCell, forRowAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> operations = operations[indexPath] &#123;</span><br><span class="line">        <span class="keyword">for</span> operation <span class="keyword">in</span> operations &#123;</span><br><span class="line">            operation.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center">

<p><img src="/Post-Resources/Operations_2/final.gif" alt="" title="Final app"></p>
</div>

<p>Ahora, deber√≠as ver que la aplicaci√≥n funciona correctamente. Adem√°s, al iniciar y cancelar las operaciones de manera inteligente, estamos ahorrando tr√°fico de red as√≠ como reduciendo el consumo de bater√≠a. Esas cosas pueden hacer que nuestra aplicaci√≥n funcione m√°s r√°pido.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusi√≥n"></a>Conclusi√≥n</h2><p>Hay algunos beneficios de <code>Operation</code> sobre GCD que mantienen nuestro c√≥digo fuente mantenible y reutilizable.<br>Por √∫ltimo mencionar, por favor ten cuidado al usar Operation o GCD porque la concurrencia a veces introduce errores que no siempre son transparentes de encontrar y corregir. <a href="http://localhost:4000/2017/10/20/Review-Book-Clean-Code/">En el libro Clean Code</a>, Robert C. Martin establece algunos puntos importantes cuando se trabaja con m√∫ltiples hilos</p>
<blockquote>
<p>Hay algunas definiciones b√°sicas que debemos conocer cuando hablamos de concurrencia e hilos: Recursos limitados, exclusi√≥n mutua, inanici√≥n, deadlock y livelock.</p>
</blockquote>
<blockquote>
<p>La concurrencia no siempre mejora el rendimiento. A veces incurre en alg√∫n overhead y los errores que provienen de ella no suelen ser repetibles.</p>
</blockquote>
<blockquote>
<p>Limita el acceso a los datos que se comparten entre m√°s de dos hilos. Usa copias de datos si hay una posibilidad.</p>
</blockquote>
<blockquote>
<p>Mant√©n las secciones sincronizadas lo m√°s peque√±as posible porque los Locks crean retrasos y agregan overhead. Son costosos.</p>
</blockquote>
<blockquote>
<p>El c√≥digo multihilo se comporta de manera diferente en diferentes entornos: Ejecuta pruebas en cada entorno de despliegue potencial.</p>
</blockquote>
<p>Puedes encontrar el proyecto final a trav√©s del <a href="https://github.com/uynguyen/iOS-Operations">enlace</a><br>Gracias por leer.</p>
<h2 id="Referencias"><a href="#Referencias" class="headerlink" title="Referencias"></a>Referencias</h2><ul>
<li>Cap√≠tulo 6: Operations, Concurrency By Tutorials - Multithreading in Swift with GCD and Operations, Raywenderlich,</li>
<li>Cap√≠tulo 7: Concurrency and Multitasking, iOS 8 Swift Programming Cookbook, O‚ÄôReilly.</li>
</ul>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/"></a><a class="link-muted mr-2" rel="tag" href="/"></a><a class="link-muted mr-2" rel="tag" href="/"></a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5e9474199d6bcc0012d5bba6&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="https://ko-fi.com/uynguyen" style="background-color:rgba(255,128,62,.87);border-color:transparent;color:white;" target="_blank" rel="noopener"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button is-warning donate" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="uynguyen.itus@gmail.com"><input type="hidden" name="currency_code" value="USD"></form></div></div></div><div class="card"><div class="card-content"><h3 class="title is-5">Comentarios</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://uynguyen.github.io/es/posts/Advanced-iOS-Concurrency-Async-Operations-2/index.html';
            this.page.identifier = 'es/posts/Advanced-iOS-Concurrency-Async-Operations-2/index.html';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'uynguyen-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen"></figure><p class="title is-size-4 is-block line-height-inherit">Uy Nguyen</p><p class="is-size-6 is-block">Software engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-envelope mr-1"></i><span>uynguyen.itus@gmail.com</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Entradas</p><a href="/archives"><p class="title">58</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categor√≠as</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Etiquetas</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-rounded" style="background-color:#f14668e3;color:white;font-weight:bold;" href="https://ko-fi.com/uynguyen" target="_blank" rel="noopener">if üëç then Buy me a Coffee</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/uynguyen"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://www.linkedin.com/in/uynguyen505"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Enlaces</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://uynguyen.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Uy Nguyen</span></span><span class="level-right"><span class="level-item tag">uynguyen.github.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recientes</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2025-04-02T11:03:38.000Z">2025-04-02</time></p><p class="title is-6"><a class="link-muted" href="/2025/04/02/Bluetooth-security-Implement-authentication/">Securing Bluetooth Communication: Implementing Authentication and Encryption Flows</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-11-03T03:33:53.000Z">2024-11-03</time></p><p class="title is-6"><a class="link-muted" href="/2024/11/03/iOS-18-What-s-news-in-CoreBluetooth/">iOS 18: What&#039;s news in CoreBluetooth?</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-31T03:38:32.000Z">2024-08-31</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/31/Bluetooth-security-Pairing-and-Bonding/">Bluetooth security: Pairing and Bonding</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-04T05:10:39.000Z">2024-08-04</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/04/Android-Bluetooth-A-Pitfall/">Android Bluetooth: A Pitfall</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-06-30T03:48:09.000Z">2024-06-30</time></p><p class="title is-6"><a class="link-muted" href="/2024/06/30/Best-practice-iOS-vs-Android-Bluetooth/">Best practice: iOS vs Android Bluetooth</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Etiquetas</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Appclip/"><span class="tag">Appclip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLE/"><span class="tag">BLE</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bluetooth/"><span class="tag">Bluetooth</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Books/"><span class="tag">Books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocoa/"><span class="tag">Cocoa</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Concurrency/"><span class="tag">Concurrency</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Conference/"><span class="tag">Conference</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Core-Data/"><span class="tag">Core Data</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CoreBluetooh/"><span class="tag">CoreBluetooh</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CrossPlatform/"><span class="tag">CrossPlatform</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Design-Patterns/"><span class="tag">Design Patterns</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DispatchQueue/"><span class="tag">DispatchQueue</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Memory-management/"><span class="tag">Memory management</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Notification/"><span class="tag">Notification</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Objective-C/"><span class="tag">Objective-C</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operations/"><span class="tag">Operations</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ReactNative/"><span class="tag">ReactNative</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Software-Architecture/"><span class="tag">Software Architecture</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Study/"><span class="tag">Study</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UI/"><span class="tag">UI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UIStackView/"><span class="tag">UIStackView</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UML/"><span class="tag">UML</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vendor/"><span class="tag">Vendor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WatchOS/"><span class="tag">WatchOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Web-Bluetooth/"><span class="tag">Web Bluetooth</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/books/"><span class="tag">books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iBeacon/"><span class="tag">iBeacon</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/study/"><span class="tag">study</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a><p class="size-small"><span>&copy; Uy Nguyen</span>¬†¬†Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>¬†&amp;¬†<a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("es");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://uynguyen.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Teclea algo..."></div><a class="searchbox-close" href="javascript:;">√ó</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Teclea algo...","untitled":"(Untitled)","posts":"Entradas","pages":"Pages","categories":"Categor√≠as","tags":"Etiquetas"});
        });</script></body></html>