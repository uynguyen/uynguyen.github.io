<!doctype html>
<html lang="es"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Advanced iOS Concurrency: Async Operations [2] - Uy Nguyen</title><meta description="In the previous post, Advanced iOS Concurrency: Operations, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover im"><meta property="og:type" content="blog"><meta property="og:title" content="Advanced iOS Concurrency: Async Operations [2]"><meta property="og:url" content=":year/:month/:day/:title/"><meta property="og:site_name" content="Uy Nguyen"><meta property="og:description" content="In the previous post, Advanced iOS Concurrency: Operations, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover im"><meta property="og:locale" content="es_ES"><meta property="article:published_time" content="2020-05-30T10:02:31.000Z"><meta property="article:modified_time" content="2024-03-23T03:54:36.080Z"><meta property="article:author" content="Uy Nguyen"><meta property="article:tag" content="Concurrency"><meta property="article:tag" content="Operations"><meta property="article:tag" content="iOS"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/Post-Resources/Operations_2/operations.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://uynguyen.github.io/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/"},"headline":"Uy Nguyen","image":["https://uynguyen.github.io/Post-Resources/Operations_2/operations.png","https://uynguyen.github.io/Post-Resources/Operations_2/Async_Operation_State.png","https://uynguyen.github.io/Post-Resources/Operations_2/final.gif"],"datePublished":"2020-05-30T10:02:31.000Z","dateModified":"2024-03-23T03:54:36.080Z","author":{"@type":"Person","name":"Uy Nguyen"},"description":"In the previous post, Advanced iOS Concurrency: Operations, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover im"}</script><link rel="canonical" href="https://uynguyen.github.io/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/"><link rel="icon" href="/Post-Resources/UyNguyen.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><meta property="og:image" content="/Post-Resources/Operations_2/operations.png"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-163508356-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-163508356-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><div class="navbar-item has-dropdown is-hoverable language-switcher is-hidden-mobile"><a class="navbar-link" title="Idioma"><i class="fas fa-globe"></i></a><div class="navbar-dropdown is-right"><a class="navbar-item" href="/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/">English</a><a class="navbar-item" href="/vi/posts/Advanced-iOS-Concurrency-Async-Operations-2.html">Ti·∫øng Vi·ªát</a><a class="navbar-item is-active" href="/es/posts/Advanced-iOS-Concurrency-Async-Operations-2.html">Espa√±ol</a></div></div><a class="navbar-item search is-hidden-mobile" title="Buscar" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><div class="mobile-toolbar is-hidden-tablet"><div class="container"><div class="mobile-toolbar-content"><button class="mobile-toolbar-btn" id="mobile-lang-btn" title="Idioma"><i class="fas fa-globe"></i><span>Espa√±ol</span></button><button class="mobile-toolbar-btn search" title="Buscar"><i class="fas fa-search"></i><span>Buscar</span></button></div></div></div><div class="language-picker-overlay" id="lang-picker-overlay"><div class="language-picker-backdrop"></div><div class="language-picker-modal"><div class="language-picker-header"><span>Idioma</span><button class="language-picker-close" id="lang-picker-close"><i class="fas fa-times"></i></button></div><div class="language-picker-options"><a class="language-picker-option" href="/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/"><span class="lang-name">English</span></a><a class="language-picker-option" href="/vi/posts/Advanced-iOS-Concurrency-Async-Operations-2.html"><span class="lang-name">Ti·∫øng Vi·ªát</span></a><a class="language-picker-option is-active" href="/es/posts/Advanced-iOS-Concurrency-Async-Operations-2.html"><span class="lang-name">Espa√±ol</span><i class="fas fa-check"></i></a></div></div></div><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"></div></div><h1 class="title is-3 is-size-4-mobile">Advanced iOS Concurrency: Async Operations [2]</h1><div class="content"><p><img src="/Post-Resources/Operations_2/operations.png" alt="" title="Operations"></p>
<p>In the previous post, <a href="/2020/05/16/iOS-Concurrency-Operations">Advanced iOS Concurrency: Operations</a>, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover images, they will be applied to a simple filter, then be displayed in a table view. The application, however, has not been completed yet. There‚Äôs something that went wrong with our app making the app did not show downloaded images properly. In this tutorial, we will continue where we left off.<br>Get ready!</p>
<a id="more"></a> 
<h2 id="Operation-life-cycle"><a href="#Operation-life-cycle" class="headerlink" title="Operation life cycle"></a>Operation life cycle</h2><p>To find out why our app did not function properly, let‚Äôs review the current source code</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadImageOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> !isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">URLSession</span>.shared.dataTask(with: <span class="keyword">self</span>.url, completionHandler: &#123; (data, res, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span>,</span><br><span class="line">                <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.outputImage = <span class="type">UIImage</span>(data: data)</span><br><span class="line">        &#125;).resume()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following image describes the changes in states of operations.<br><img src="/Post-Resources/Operations_2/Async_Operation_State.png" alt="" title="Async_Operation_State"></p>
<p>When the <code>main</code> method gets called, it will execute our asynchronous task and then exit immediately making the state of the operation switch to <code>isFinish</code>. At that point, our asynchronous task actually has not completed yet.<br>Currently, we‚Äôre calling to download an image inside the <code>main</code> method of the Operation. The root cause is related to the Operation Life Cycle itself. Thus, to support asynchronous operations in our app, we need to manually manage states of operations.</p>
<h2 id="Key-Value-Observing"><a href="#Key-Value-Observing" class="headerlink" title="Key-Value Observing"></a><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Key-Value Observing</a></h2><p>Before implementing our custom Async Operation class, we need to learn a new concept first: KVO. I assume that you‚Äôve not heard about this concept so we will have a quick look at it first.<br>Key-Value Observing, aka KVO, is one of the techniques for observing the state changes of an object in Objective-C and Swift. Whenever the value of the observed properties changed, the observing block of code will execute. At the heart of KVO, the main concept is based on the Observer Pattern.<br>Swift classes that are inherited from <code>NSObject</code> class have methods to allow other objects to observe their properties.</p>
<blockquote>
<p>Key-value observing provides a mechanism that allows objects to be notified of changes to specific properties of other objects. It is particularly useful for communication between model and controller layers in an application.</p>
</blockquote>
<p>Let‚Äôs create a Playground to test it.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditCard</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">dynamic</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> number: <span class="type">Int</span> = <span class="number">1000</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">increaseNumber</span><span class="params">(by value: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.number += value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cretdit: <span class="type">CreditCard</span></span><br><span class="line">    <span class="keyword">var</span> kvoToken: <span class="type">NSKeyValueObservation?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(cretdit: <span class="type">CreditCard</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.cretdit = cretdit</span><br><span class="line">        kvoToken = <span class="keyword">self</span>.cretdit.observe(\.number, options: .new) &#123; (credit, change) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newNumber = change.newValue <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"New number is \(newNumber)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        kvoToken?.invalidate()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> credit = <span class="type">CreditCard</span>()</span><br><span class="line"><span class="keyword">let</span> person = <span class="type">Person</span>(cretdit: credit)</span><br><span class="line">credit.increaseNumber(by: <span class="number">500</span>)</span><br></pre></td></tr></table></figure>

<p>Here, I define two classes: <code>CreditCard</code> and <code>Person</code>. A <code>Person</code> object holds a <code>CreditCard</code> object as a property. What I want is whenever the <code>number</code> property of the credit card gets changed, the person will be notified. Here is KVO comes.<br>Run the above code in the playground, you should see the log <code>New number is \(newNumber)</code> print out on your console.</p>
<p>Why should we need to know about KVO? The answer is because the Operation class uses KVO notification. Whenever the state of Operation changes, a KVO notification will be sent.<br>Without KVO notifications, the OperationQueue won‚Äôt be able to observe the state of our operations so that it can not get updated correctly. Thus, when we manage the state of operation by ourselves, we must ensure those KVO notifications are sent properly.</p>
<h2 id="Async-Operation"><a href="#Async-Operation" class="headerlink" title="Async Operation"></a>Async Operation</h2><p>Let‚Äôs create <code>AsyncOperation</code> class inherited from the <code>Operation</code> class.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">State</span>: <span class="title">String</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> ready, executing, finished</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> keyPath: <span class="type">String</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"is\(rawValue.capitalized)"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The rest of code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next, We declare a property to keep track the state of the object.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> state = <span class="type">State</span>.ready &#123;</span><br><span class="line">    <span class="keyword">willSet</span> &#123;</span><br><span class="line">        willChangeValue(forKey: newValue.keyPath)</span><br><span class="line">        willChangeValue(forKey: state.keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">        didChangeValue(forKey: oldValue.keyPath)</span><br><span class="line">        didChangeValue(forKey: state.keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>Operation</code> base class needs to know the changes of both the old state and new state.<br>Take a specified case as an example, the state currently is <code>ready</code>, then we set the state to <code>executing</code>. There are 4 KVO notifications should be sent:</p>
<ul>
<li>Firstly, notify the willChangeValue for <code>isReady</code>.</li>
<li>Then. notify the willChangeValue for <code>executing</code>.</li>
<li>After that, notfiy the willChange for <code>isReady</code>.</li>
<li>Finally, notfiy the willChange for <code>executing</code>.</li>
</ul>
<p>After that, We override the properties of states.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isReady: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.isReady &amp;&amp; state == .ready</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isExecuting: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state == .executing</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isFinished: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state == .finished</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isAsynchronous: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It‚Äôs all for managing the state of Async Operation class. </p>
<p>When adding an operation to an operation queue, the <code>start</code> method is what gets called first. then it will call the <code>main</code> method of the operation executing the main block of code you have assigned to the operation.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    main()</span><br><span class="line">    state = .executing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Remember when I mentioned that Operation has killer features that make it surpass GDC? The first one is dependencies and the other one is the capability of canceling a running operation. It‚Äôs very useful in a case where we want to stop operations that are irrelevant at a certain time. For example, to cancel downloading data when the user scrolls the table making some cells disappear.<br>Let‚Äôs add this feature to our Async Operation class.<br>First, we need to modify the <code>start</code> method to check the <code>isCancelled</code> property before actually calling the <code>main</code> method.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> isCancelled &#123;</span><br><span class="line">        state = .finished</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    main()</span><br><span class="line">    state = .executing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And then override the <code>cancel</code> method to update the state to <code>finished</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    state = .finished</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At this point, we‚Äôve finished implementing our <code>Async Operation</code> class. It‚Äôs time to mix everything together in our app.</p>
<h2 id="Adding-this-all-together"><a href="#Adding-this-all-together" class="headerlink" title="Adding this all together"></a>Adding this all together</h2><p>Because the <code>DownloadImageOperation</code> class executes asynchronously, we can not set <code>Operation</code> class as its base class, we now set <code>AsyncOperation</code> instead. Kindly note that to support canceling in <code>DownloadImageOperation</code> class, we will keep the return value of creating a data task as a property of this class so that we can cancel this <code>URLSessionDataTask</code> later.<br>The <code>DownloadImageOperation</code> class will look like below.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadImageOperation</span>: <span class="title">AsyncOperation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">URL</span></span><br><span class="line">    <span class="keyword">var</span> outputImage: <span class="type">UIImage?</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> task: <span class="type">URLSessionDataTask?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(url: <span class="type">URL</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.url = url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.task = <span class="type">URLSession</span>.shared.dataTask(with: <span class="keyword">self</span>.url, completionHandler: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] (data, res, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> `<span class="keyword">self</span>` = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">defer</span> &#123; <span class="keyword">self</span>.state = .finished &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">guard</span> !<span class="keyword">self</span>.isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span>,</span><br><span class="line">                <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.outputImage = <span class="type">UIImage</span>(data: data)</span><br><span class="line">        &#125;)</span><br><span class="line">        task?.resume()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.cancel()</span><br><span class="line">        task?.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let‚Äôs back to our main <code>ViewController</code>. To cancel the running operations, we first add new dictionary as a property of <code>ViewController</code> which tracks all running operations for each table view cell at a corresponding index path.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> operations: [<span class="type">IndexPath</span>: [<span class="type">Operation</span>]] = [:]</span><br></pre></td></tr></table></figure>

<p>Inside the <code>func tableView(_ tableView:cellForRowAt indexPath:)</code> delegate, after adding two operations to the operation queue, we will also add them to the <code>operations</code> dictionary for tracking. Additionally, if there is an operation for this index path, cancel it before holding the new one.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> existingOperations = operations[indexPath] &#123;</span><br><span class="line">    <span class="keyword">for</span> operation <span class="keyword">in</span> existingOperations &#123;</span><br><span class="line">        operation.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">operations[indexPath] = [grayScaleOpt, downloadOpt]</span><br></pre></td></tr></table></figure>

<p>When the user scrolls the table, some cells disappear and the delegate <code>func tableView(_ tableView:didEndDisplaying cell:indexPath:)</code> gets called. At that point, we‚Äôll also cancel the running operations for that cell ensuring that only operations of visible cells are executing.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didEndDisplaying cell: UITableViewCell, forRowAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> operations = operations[indexPath] &#123;</span><br><span class="line">        <span class="keyword">for</span> operation <span class="keyword">in</span> operations &#123;</span><br><span class="line">            operation.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center">

<p><img src="/Post-Resources/Operations_2/final.gif" alt="" title="Final app"></p>
</div>

<p>Now, you should see the app now works properly. Additionally, by starting and canceling the operations wisely, we‚Äôre saving the network traffic as well as reduce the battery consumption. Those things can make our app run faster.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>There are some benefits of <code>Operation</code> over GCD that keep our source code maintainable and reusable.<br>The last to mention, please careful when using Operation or GCD because Concurrency sometimes introduces bugs that are not always transparent to find and fix. <a href="http://localhost:4000/2017/10/20/Review-Book-Clean-Code/">In Clean Code Book</a>, Robert C. Martin states some important points when working with multiple threads</p>
<blockquote>
<p>There are some basic definitions we should know when we talk about concurrency and threads: Bound resources, mutual exclusion, starvation, deadlock, and livelock.</p>
</blockquote>
<blockquote>
<p>Concurrency does not always improve performance. It sometimes incurs some overhead and bugs come from it are not usually repeatable.</p>
</blockquote>
<blockquote>
<p>Limit the access of the data that is shared between more than two threads. Use copies of data if there is a chance.</p>
</blockquote>
<blockquote>
<p>Keep the synchronized sections as small as possible because Locks create delays and add overhead. They are expensive.</p>
</blockquote>
<blockquote>
<p>Multithreaded code behaves differently in different environments: Run tests in every potential deployment environment.</p>
</blockquote>
<p>You can find the final project via the <a href="https://github.com/uynguyen/iOS-Operations">link</a><br>Thank you for reading.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li>Chapter 6: Operations, Concurrency By Tutorials - Multithreading in Swift with GCD and Operations, Raywenderlich,</li>
<li>Chapter 7: Concurrency and Multitasking, iOS 8 Swift Programming Cookbook, O‚ÄôReilly.</li>
</ul>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Concurrency/">Concurrency</a><a class="link-muted mr-2" rel="tag" href="/tags/Operations/">Operations</a><a class="link-muted mr-2" rel="tag" href="/tags/iOS/">iOS</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5e9474199d6bcc0012d5bba6&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="https://ko-fi.com/uynguyen" style="background-color:rgba(255,128,62,.87);border-color:transparent;color:white;" target="_blank" rel="noopener"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button is-warning donate" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="uynguyen.itus@gmail.com"><input type="hidden" name="currency_code" value="USD"></form></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/06/14/Review-book-Building-Applications-With-iBeacon/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Review book: Building Applications With iBeacon</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/05/16/iOS-Concurrency-Operations/"><span class="level-item">Advanced iOS Concurrency: Operations [1]</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comentarios</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://uynguyen.github.io/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/';
            this.page.identifier = 'es/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'uynguyen-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen"></figure><p class="title is-size-4 is-block line-height-inherit">Uy Nguyen</p><p class="is-size-6 is-block">Software engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-envelope mr-1"></i><span>uynguyen.itus@gmail.com</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Entradas</p><a href="/archives"><p class="title">59</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categor√≠as</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Etiquetas</p><a href="/tags"><p class="title">36</p></a></div></div></nav><div class="level"><a class="level-item button is-rounded" style="background-color:#f14668e3;color:white;font-weight:bold;" href="https://ko-fi.com/uynguyen" target="_blank" rel="noopener">if üëç then Buy me a Coffee</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/uynguyen"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://www.linkedin.com/in/uynguyen505"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Enlaces</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://uynguyen.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Uy Nguyen</span></span><span class="level-right"><span class="level-item tag">uynguyen.github.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recientes</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2026-01-31T03:00:00.000Z">2026-01-31</time></p><p class="title is-6"><a class="link-muted" href="/2026/01/31/Bluetooth-Callback-vs-Reactive-Programming/">Bluetooth Development: Callback vs Reactive Programming</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2025-04-02T11:03:38.000Z">2025-04-02</time></p><p class="title is-6"><a class="link-muted" href="/2025/04/02/Bluetooth-security-Implement-authentication/">Securing Bluetooth Communication: Implementing Authentication and Encryption Flows</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-11-03T03:33:53.000Z">2024-11-03</time></p><p class="title is-6"><a class="link-muted" href="/2024/11/03/iOS-18-What-s-news-in-CoreBluetooth/">iOS 18: What&#039;s news in CoreBluetooth?</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-31T03:38:32.000Z">2024-08-31</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/31/Bluetooth-security-Pairing-and-Bonding/">Bluetooth security: Pairing and Bonding</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-04T05:10:39.000Z">2024-08-04</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/04/Android-Bluetooth-A-Pitfall/">Android Bluetooth: A Pitfall</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Etiquetas</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Appclip/"><span class="tag">Appclip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLE/"><span class="tag">BLE</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bluetooth/"><span class="tag">Bluetooth</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Books/"><span class="tag">Books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocoa/"><span class="tag">Cocoa</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Concurrency/"><span class="tag">Concurrency</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Conference/"><span class="tag">Conference</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Core-Data/"><span class="tag">Core Data</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CoreBluetooh/"><span class="tag">CoreBluetooh</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CrossPlatform/"><span class="tag">CrossPlatform</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Design-Patterns/"><span class="tag">Design Patterns</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DispatchQueue/"><span class="tag">DispatchQueue</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Memory-management/"><span class="tag">Memory management</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Notification/"><span class="tag">Notification</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Objective-C/"><span class="tag">Objective-C</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operations/"><span class="tag">Operations</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ReactNative/"><span class="tag">ReactNative</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reactive/"><span class="tag">Reactive</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RxJava/"><span class="tag">RxJava</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RxSwift/"><span class="tag">RxSwift</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Software-Architecture/"><span class="tag">Software Architecture</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Study/"><span class="tag">Study</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UI/"><span class="tag">UI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UIStackView/"><span class="tag">UIStackView</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UML/"><span class="tag">UML</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vendor/"><span class="tag">Vendor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WatchOS/"><span class="tag">WatchOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Web-Bluetooth/"><span class="tag">Web Bluetooth</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/books/"><span class="tag">books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iBeacon/"><span class="tag">iBeacon</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag is-grey-lightest">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/study/"><span class="tag">study</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a><p class="size-small"><span>&copy; Uy Nguyen</span>¬†¬†Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>¬†&amp;¬†<a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("es");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://uynguyen.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Teclea algo..."></div><a class="searchbox-close" href="javascript:;">√ó</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Teclea algo...","untitled":"(Untitled)","posts":"Entradas","pages":"Pages","categories":"Categor√≠as","tags":"Etiquetas"});
        });</script></body></html>