<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Best practice: iOS background processing - Background App Refresh Task | Uy Nguyen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers ge">
<meta property="og:type" content="article">
<meta property="og:title" content="Best practice: iOS background processing - Background App Refresh Task">
<meta property="og:url" content="https://uynguyen.github.io/2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/index.html">
<meta property="og:site_name" content="Uy Nguyen">
<meta property="og:description" content="Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers ge">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/RefreshAppBg.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/app_refresh_setting.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/factors.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/BG-Capabilities.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/simulate_bg_fetch.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/Expectation.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/Reality.png">
<meta property="article:published_time" content="2020-09-26T14:53:32.000Z">
<meta property="article:modified_time" content="2024-03-23T03:54:36.080Z">
<meta property="article:author" content="Uy Nguyen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://uynguyen.github.io/Post-Resources/RefreshInBg/RefreshAppBg.png">
  
    <link rel="alternate" href="/atom.xml" title="Uy Nguyen" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Uy Nguyen</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Be a Software Engineer, not a Coder.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://uynguyen.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Best-practice-iOS-background-processing-Background-App-Refresh-Task" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/" class="article-date">
  <time datetime="2020-09-26T14:53:32.000Z" itemprop="datePublished">2020-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Best practice: iOS background processing - Background App Refresh Task
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/Post-Resources/RefreshInBg/RefreshAppBg.png" alt="" title="Cover"></p>
<p>Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers get out of control of their app. How and when your app gets a chance to execute your task totally depends on the system. At the heart of iOS, Apple uses its own internally-complex algorithm to determines which apps are allowed to run in the background, based on various factors such as the pattern of user activity, current battery state, etc.<br>In this tutorial, we will learn how to request periodic execution time on iOS. After understanding how it works, we will apply this technique to a BLE-based app in some specific cases in the next tutorial.<br>Let’s rock!</p>
<a id="more"></a> 

<h2 id="Foundational-knowledge"><a href="#Foundational-knowledge" class="headerlink" title="Foundational knowledge"></a>Foundational knowledge</h2><p>Before taking deep dive into practice, it’s good to understand how iOS manages application states. It’s been the first time Apple officially announces a video that describes top factors contributing to the app launch times at WWDC (<a href="https://developer.apple.com/videos/play/wwdc2020/10063/?fbclid=IwAR1_oejf0JY9B8yV4d9riMAH4MQsLasO86iVjhwqmAruw2v64_utbuGZIEc" target="_blank" rel="noopener">WWDC 2020 - Background execution demystified</a>). To summarize, Apple designs iOS in a way allowing applications to keep its content up to date on one hand. On the other hand, iOS must adapt to its major goals: </p>
<ul>
<li><strong>Battery life</strong>: allowing background execution while maintaining all-day battery life.</li>
<li><strong>Performance</strong>: ensure background execution does not have any negative effect on active usage.</li>
<li><strong>Privacy</strong>: Users should be aware of background tasks based on their particular usage patterns.</li>
<li><strong>Respecting user intent</strong>: if a user takes a certain action, make sure the system responds to correctly.</li>
</ul>
<p>With these goals in mind, here are the top 7 factors that play a role in system scheduling of background execution.</p>
<ul>
<li><strong>Critical low battery</strong>: When the phone is about to run out of battery (&lt; 20%), background execution will be pause by the system to avoid battery usage.</li>
<li><strong>Low power mode</strong>: When users change to phone to low power mode, the user explicitly indicates that the system should preserve battery for critical tasks only. </li>
<li><strong>Background App refresh setting</strong>: The user can toggle the setting to allow or not a specified app can run background tasks.<br><img src="/Post-Resources/RefreshInBg/app_refresh_setting.png" alt="" title="App refresh setting"></li>
<li><strong>App usage</strong>: There is a limit of resources on the phone so that the system must priorities which apps it should allocate resources for. Typically, apps that the user uses the most. Apple also mentioned to “On-device predictive engine” that learns which apps the user often uses and when. The on-device predictive engine will rely on this information to priorities background execution.</li>
<li><strong>App switcher</strong>: Only apps are visible in App Switcher have opportunities to run background tasks.</li>
<li><strong>System budget</strong>: Ensure background activities do not drain battery and data plans, there is a limit of battery and data of background execution throughout the day.</li>
<li><strong>Rate limit</strong>: The system performs sone rate-limiting per launch.</li>
</ul>
<p>and some other factors: Airplane mode, device temperature, display, device lock state, etc.</p>
<p><img src="/Post-Resources/RefreshInBg/factors.png" alt="" title="Factors"></p>
<h2 id="Capabilities"><a href="#Capabilities" class="headerlink" title="Capabilities"></a>Capabilities</h2><p>Make sure your app has added these following capabilities</p>
<p><img src="/Post-Resources/RefreshInBg/BG-Capabilities.png" alt="" title="Capability"></p>
<h2 id="Prior-to-iOS-13"><a href="#Prior-to-iOS-13" class="headerlink" title="Prior to iOS 13"></a>Prior to iOS 13</h2><p>It’s quite simple to set up a background fetch prior to iOS 13.<br>Inside the <code>application(_:didFinishLaunchingWithOptions)</code> method, we should add the following command.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIApplication</span>.shared.setMinimumBackgroundFetchInterval(<span class="type">UIApplication</span>.backgroundFetchIntervalMinimum)</span><br></pre></td></tr></table></figure>
<p>The <code>setMinimumBackgroundFetchInterval</code> specifies the minimum amount of time that must elapse between background fetch executions. However, the exact timing of the event is up to the system. Generally, <code>UIApplicationBackgroundFetchIntervalMinimum</code> is a good default value to use.</p>
<p>Once your app has a chance to perform background tasks, the event <code>application(_:,performFetchWithCompletionHandler)</code> will be triggered.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, performFetchWithCompletionHandler completionHandler: @escaping <span class="params">(UIBackgroundFetchResult)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="type">Logger</span>.shared.debug(<span class="string">"\(Date().toString()) perfom bg fetch"</span>)</span><br><span class="line">    completionHandler(.newData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Don’t forget to call <code>completionHandler</code> callback. If you do not call this callback, the system does not aware your task has been completed, which leads to limiting your app from waking up on the next events</strong></p>
<p>To simulate background fetch, from the tab bar &gt; Debug &gt; Simulate background fetch. Note that it works only when running on real devices.</p>
<p><img src="/Post-Resources/RefreshInBg/simulate_bg_fetch.png" alt="" title="Simulate background fetch"></p>
<iframe width="100%" height="415" src="https://www.youtube.com/embed/oOysGc_f0pA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h2 id="iOS-13-Advance-Background-processing-WWDC-2019-and-Background-execution-demystified-WWDC-2020"><a href="#iOS-13-Advance-Background-processing-WWDC-2019-and-Background-execution-demystified-WWDC-2020" class="headerlink" title="iOS 13+, Advance Background processing - WWDC 2019 and Background execution demystified - WWDC 2020"></a>iOS 13+, Advance Background processing - WWDC 2019 and Background execution demystified - WWDC 2020</h2><p><a href="https://developer.apple.com/videos/play/wwdc2019/707/" target="_blank" rel="noopener">At WWDC 2019</a>, Apple introduced a new framework for scheduling background work: <code>BackgroundTasks</code>. This new framework does better support for tasks that are needed to be done in the background. There are two kinds of tasks supported by <code>BackgroundTasks</code> framework: <code>BGAppRefreshTaskRequest</code>, and <code>BGProcessingTaskRequest</code>. With the presence of the new framework, Apple marked deprecated on the old one from iOS 13, and no longer support on MacOS.<br>Firstly, we have to register the identifiers of background tasks executed in our app. Open <code>info.plist</code> file, and add the following information.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;BGTaskSchedulerPermittedIdentifiers&lt;/key&gt;</span><br><span class="line">&lt;array&gt;</span><br><span class="line">    &lt;string&gt;YOUR_REFRESH_TASK_ID&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;YOUR_PROCESSING_TASK_ID&lt;/string&gt;</span><br><span class="line">&lt;/array&gt;</span><br></pre></td></tr></table></figure>

<p>Forget the above step leading to a crash at runtime.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">24</span>:<span class="number">40.648838</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">275</span>:<span class="number">5188</span>] *** <span class="type">Terminating</span> app due to uncaught exception '<span class="type">NSInternalInconsistencyException'</span>, reason: '<span class="type">No</span> launch handler registered <span class="keyword">for</span> task with identifier com.example.bgRefresh'</span><br></pre></td></tr></table></figure>

<p><code>BGAppRefreshTaskRequest</code> is used when you need to execute a task in the background in a short time.<br>Refresh tasks like fetching social media feed, new emails, latest stock prices, etc are appropriate to schedule by <code>BGAppRefreshTaskRequest</code>. 30s is the time the system allows your task to execute per launch.</p>
<p>Several minutes of run times to finish your work when you register a <code>BGProcessingTaskRequest</code>. Tasks such as Core ML training on the device should be registered by a <code>BGProcessingTaskRequest</code>.</p>
<p>To register background tasks, inside the <code>application(_:didFinishLaunchingWithOptions)</code> method, we should add the following command.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: <span class="keyword">Any</span>]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> #available(iOS <span class="number">13</span>, *) &#123;</span><br><span class="line">            <span class="type">BGTaskScheduler</span>.shared.register(forTaskWithIdentifier: appRefreshTaskId, using: <span class="literal">nil</span>) &#123; task <span class="keyword">in</span></span><br><span class="line">                <span class="type">Logger</span>.shared.info(<span class="string">"[BGTASK] Perform bg fetch \(appRefreshTaskId)"</span>)</span><br><span class="line">                task.setTaskCompleted(success: <span class="literal">true</span>)</span><br><span class="line">                <span class="keyword">self</span>.scheduleAppRefresh()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">BGTaskScheduler</span>.shared.register(forTaskWithIdentifier: appProcessingTaskId, using: <span class="literal">nil</span>) &#123; task <span class="keyword">in</span></span><br><span class="line">                <span class="type">Logger</span>.shared.info(<span class="string">"[BGTASK] Perform bg processing \(appProcessingTaskId)"</span>)</span><br><span class="line">                task.setTaskCompleted(success: <span class="literal">true</span>)</span><br><span class="line">                <span class="keyword">self</span>.scheduleBackgroundProcessing()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@available</span>(iOS <span class="number">13.0</span>, *)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scheduleAppRefresh</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">BGAppRefreshTaskRequest</span>(identifier: <span class="string">"YOUR_REFRESH_TASK_ID"</span>)</span><br><span class="line"></span><br><span class="line">        request.earliestBeginDate = <span class="type">Date</span>(timeIntervalSinceNow: <span class="number">5</span> * <span class="number">60</span>) <span class="comment">// Refresh after 5 minutes.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> <span class="type">BGTaskScheduler</span>.shared.submit(request)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not schedule app refresh task \(error.localizedDescription)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@available</span>(iOS <span class="number">13.0</span>, *)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scheduleBackgroundProcessing</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">BGProcessingTaskRequest</span>(identifier: appProcessingTaskId)</span><br><span class="line">        request.requiresNetworkConnectivity = <span class="literal">true</span> <span class="comment">// Need to true if your task need to network process. Defaults to false.</span></span><br><span class="line">        request.requiresExternalPower = <span class="literal">true</span> <span class="comment">// Need to true if your task requires a device connected to power source. Defaults to false.</span></span><br><span class="line"></span><br><span class="line">        request.earliestBeginDate = <span class="type">Date</span>(timeIntervalSinceNow: <span class="number">5</span> * <span class="number">60</span>) <span class="comment">// Process after 5 minutes.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> <span class="type">BGTaskScheduler</span>.shared.submit(request)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not schedule image fetch: (error)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>One more thing that needs to be done. When the app enters to the background, we will start scheduling background tasks.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationDidEnterBackground</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">    <span class="type">Logger</span>.shared.info(<span class="string">"App did enter background"</span>)</span><br><span class="line">    <span class="keyword">if</span> #available(iOS <span class="number">13</span>, *) &#123;</span><br><span class="line">        <span class="keyword">self</span>.scheduleAppRefresh()</span><br><span class="line">        <span class="keyword">self</span>.scheduleBackgroundProcessing()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>As always, It’s important to call <code>task.setTaskCompleted(success: true)</code> as quick as possible</strong>.<br>You might notice that after calling <code>task.setTaskCompleted(success: true)</code>, we need to call <code>self.scheduleAppRefresh()</code> and <code>self.scheduleBackgroundProcessing()</code> again to re-schedule these tasks to the system.</p>
<h3 id="Simulate-background-task-and-background-processing"><a href="#Simulate-background-task-and-background-processing" class="headerlink" title="Simulate background task and background processing"></a>Simulate background task and background processing</h3><p>Fortunately, Apple supports a way to trigger background execution.<br>After submitting your task to the system, pause the application by any break point. Then, enter the following command to the Xcode console.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e -l objc -- (void)[[BGTaskScheduler sharedScheduler] _simulateLaunchForTaskWithIdentifier:@<span class="string">"YOUR_REFRESH_TASK_ID || YOUR_PROCESSING_TASK_ID"</span>]</span><br></pre></td></tr></table></figure>
<p>The output should be</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">53</span>:<span class="number">58.628667</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17115</span>] 💚-<span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">53</span>:<span class="number">58.628</span> +<span class="number">0700</span> <span class="type">Start</span> schedule app refresh</span><br><span class="line">(lldb) e -l objc -- (void)[[<span class="type">BGTaskScheduler</span> sharedScheduler] _simulateLaunchForTaskWithIdentifier:@<span class="string">"com.example.bgRefresh"</span>]</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">01.927263</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">16973</span>] <span class="type">Simulating</span> launch <span class="keyword">for</span> task with identifier com.example.bgRefresh</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">03.669153</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17095</span>] <span class="type">Starting</span> simulated task: &lt;decode: missing data&gt;</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.560697</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17095</span>] <span class="type">Marking</span> simulated task complete: &lt;<span class="type">BGAppRefreshTask</span>: com.example.bgRefresh&gt;</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.560750</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17012</span>] 💙-<span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">06.045</span> +<span class="number">0700</span> [<span class="type">BGTASK</span>] <span class="type">Perform</span> bg fetch com.example.bgRefresh</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.563846</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17012</span>] 💚-<span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.562</span> +<span class="number">0700</span> <span class="type">Start</span> schedule app refresh</span><br></pre></td></tr></table></figure>

<iframe width="100%" height="415" src="https://www.youtube.com/embed/e6KFwzZKmns" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<h2 id="Expectation-vs-Reality"><a href="#Expectation-vs-Reality" class="headerlink" title="Expectation vs Reality"></a>Expectation vs Reality</h2><p>You might expect that background execution would be evenly distributes through out the day.<br><img src="/Post-Resources/RefreshInBg/Expectation.png" alt="" title="Expectation"></p>
<p>However, here is what we observe in reality. Because of the 7 factors I introduced at the beginning of this tutorial, the “On-device predictive engine” learns the user usage pattern and understands that the user typically opens the app in the morning, lunchtime, and in the evening. That’s why the system will allow your background tasks to launch just before the user foregrounds the app. Other factors that affect the result are if the user toggled “Low power mode”, or if the phone fell into the critical low battery state.<br><img src="/Post-Resources/RefreshInBg/Reality.png" alt="" title="Reality"></p>
<h2 id="Best-advices"><a href="#Best-advices" class="headerlink" title="Best advices"></a>Best advices</h2><ul>
<li>Background tasks will not be run until the first device unlocks after the reboot.</li>
<li>We can check if the user is in low power mode:<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessInfo</span>.processInfo.isLowPowerModeEnabled</span><br><span class="line"><span class="type">NSProcessInfoPowerStateDidChange</span></span><br></pre></td></tr></table></figure></li>
<li>We also can check the “background refresh setting” status.<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIApplication</span>.shared.backgroundRefreshStatus</span><br><span class="line"><span class="type">UIApplication</span>.backgroundStatusDidChangeNotification</span><br></pre></td></tr></table></figure></li>
<li>Minimize data usage: Using thumbnails instead of full images, and only download what’s really necessary.</li>
<li>Minimize power consumption: avoid unnecessary hardware usage such as GPS, accelerometer, etc. Also, make sure you complete the task as soon as possible.</li>
<li>Use <code>BackgroundURLSession</code> to offload the work from the app to the system.</li>
</ul>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>In this post, we take a deep dive into what factors contributed to your background executions, and understand are key differences between <code>BGAppRefreshTaskRequest</code> and  <code>BGProcessingTaskRequest</code>. We also take a demo project to see how it actually works in reality.<br>Next time, you can choose what kind of request is most appropriate to your tasks, and how you can respond gracefully to your user’s intent.<br>Hopefully, the information that this post brings in helps you build better applications: freshness and optimization.<br>There is another technique to wake your app up, silent notification. We will talk about it in the next tutorial.<br>Happy weekend!</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="https://developer.apple.com/videos/play/wwdc2020/10063" target="_blank" rel="noopener">Background execution demystified WWDC 2020</a></li>
<li><a href="https://developer.apple.com/videos/play/wwdc2019/707/" target="_blank" rel="noopener">Advances in App Background Execution WWDC 2019</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://uynguyen.github.io/2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/" data-id="clu3nvc5q000bxzvqfzvye775" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/02/25/WWDC-2020-Top-reasons-why-app-get-killed-in-background/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          WWDC 2020 - Top reasons why app get killed in background
        
      </div>
    </a>
  
  
    <a href="/2020/09/26/Review-book-RxSwift-Reactive-Programming-with-Swift/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Review book: RxSwift Reactive Programming with Swift </div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Appclip/" rel="tag">Appclip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BLE/" rel="tag">BLE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bluetooth/" rel="tag">Bluetooth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Books/" rel="tag">Books</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cocoa/" rel="tag">Cocoa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Concurrency/" rel="tag">Concurrency</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Conference/" rel="tag">Conference</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Core-Data/" rel="tag">Core Data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CoreBluetooh/" rel="tag">CoreBluetooh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CrossPlatform/" rel="tag">CrossPlatform</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Patterns/" rel="tag">Design Patterns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DispatchQueue/" rel="tag">DispatchQueue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memory-management/" rel="tag">Memory management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Notification/" rel="tag">Notification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Objective-C/" rel="tag">Objective-C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Operations/" rel="tag">Operations</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReactNative/" rel="tag">ReactNative</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Software-Architecture/" rel="tag">Software Architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Study/" rel="tag">Study</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/" rel="tag">Swift</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/" rel="tag">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UIStackView/" rel="tag">UIStackView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UML/" rel="tag">UML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vendor/" rel="tag">Vendor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WatchOS/" rel="tag">WatchOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web-Bluetooth/" rel="tag">Web Bluetooth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/books/" rel="tag">books</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iBeacon/" rel="tag">iBeacon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macOS/" rel="tag">macOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/study/" rel="tag">study</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 11.67px;">Android</a> <a href="/tags/Appclip/" style="font-size: 10px;">Appclip</a> <a href="/tags/BLE/" style="font-size: 18.33px;">BLE</a> <a href="/tags/Bluetooth/" style="font-size: 13.33px;">Bluetooth</a> <a href="/tags/Books/" style="font-size: 10px;">Books</a> <a href="/tags/Cocoa/" style="font-size: 10px;">Cocoa</a> <a href="/tags/Concurrency/" style="font-size: 15px;">Concurrency</a> <a href="/tags/Conference/" style="font-size: 10px;">Conference</a> <a href="/tags/Core-Data/" style="font-size: 10px;">Core Data</a> <a href="/tags/CoreBluetooh/" style="font-size: 11.67px;">CoreBluetooh</a> <a href="/tags/CrossPlatform/" style="font-size: 10px;">CrossPlatform</a> <a href="/tags/Design-Patterns/" style="font-size: 10px;">Design Patterns</a> <a href="/tags/DispatchQueue/" style="font-size: 10px;">DispatchQueue</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Memory-management/" style="font-size: 10px;">Memory management</a> <a href="/tags/Notification/" style="font-size: 11.67px;">Notification</a> <a href="/tags/Objective-C/" style="font-size: 10px;">Objective-C</a> <a href="/tags/Operations/" style="font-size: 11.67px;">Operations</a> <a href="/tags/ReactNative/" style="font-size: 10px;">ReactNative</a> <a href="/tags/Software-Architecture/" style="font-size: 10px;">Software Architecture</a> <a href="/tags/Study/" style="font-size: 11.67px;">Study</a> <a href="/tags/Swift/" style="font-size: 16.67px;">Swift</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/UIStackView/" style="font-size: 10px;">UIStackView</a> <a href="/tags/UML/" style="font-size: 10px;">UML</a> <a href="/tags/Vendor/" style="font-size: 10px;">Vendor</a> <a href="/tags/WatchOS/" style="font-size: 10px;">WatchOS</a> <a href="/tags/Web-Bluetooth/" style="font-size: 10px;">Web Bluetooth</a> <a href="/tags/books/" style="font-size: 10px;">books</a> <a href="/tags/iBeacon/" style="font-size: 11.67px;">iBeacon</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/macOS/" style="font-size: 10px;">macOS</a> <a href="/tags/study/" style="font-size: 10px;">study</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/30/Best-practice-iOS-vs-Android-Bluetooth/">Best practice: iOS vs Android Bluetooth</a>
          </li>
        
          <li>
            <a href="/2024/03/23/Core-Bluetooth-on-WatchOS/">Core Bluetooth on WatchOS</a>
          </li>
        
          <li>
            <a href="/2024/01/12/Protobuf/">Protobuf In Practice</a>
          </li>
        
          <li>
            <a href="/2023/11/09/What-s-new-of-Appclip-on-iOS-17/">What&#39;s new of Appclip on iOS 17?</a>
          </li>
        
          <li>
            <a href="/2023/07/22/Schedule-task-in-background-from-foreground-service/">Schedule task in background from foreground service</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 Uy Nguyen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>