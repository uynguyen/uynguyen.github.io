<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Best practice: iOS background processing - Background App Refresh Task - Uy Nguyen</title><meta description="Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers ge"><meta property="og:type" content="blog"><meta property="og:title" content="Best practice: iOS background processing - Background App Refresh Task"><meta property="og:url" content=":year/:month/:day/:title/"><meta property="og:site_name" content="Uy Nguyen"><meta property="og:description" content="Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers ge"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2020-09-26T14:53:32.000Z"><meta property="article:modified_time" content="2024-03-23T03:54:36.080Z"><meta property="article:author" content="Uy Nguyen"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/Post-Resources/RefreshInBg/RefreshAppBg.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://uynguyen.github.io/2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/"},"headline":"Uy Nguyen","image":["https://uynguyen.github.io/Post-Resources/RefreshInBg/RefreshAppBg.png","https://uynguyen.github.io/Post-Resources/RefreshInBg/app_refresh_setting.png","https://uynguyen.github.io/Post-Resources/RefreshInBg/factors.png","https://uynguyen.github.io/Post-Resources/RefreshInBg/BG-Capabilities.png","https://uynguyen.github.io/Post-Resources/RefreshInBg/simulate_bg_fetch.png","https://uynguyen.github.io/Post-Resources/RefreshInBg/Expectation.png","https://uynguyen.github.io/Post-Resources/RefreshInBg/Reality.png"],"datePublished":"2020-09-26T14:53:32.000Z","dateModified":"2024-03-23T03:54:36.080Z","author":{"@type":"Person","name":"Uy Nguyen"},"description":"Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers ge"}</script><link rel="canonical" href="https://uynguyen.github.io/2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/"><link rel="icon" href="/Post-Resources/UyNguyen.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><meta property="og:image" content="/Post-Resources/RefreshInBg/RefreshAppBg.png"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-163508356-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-163508356-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"></div></div><h1 class="title is-3 is-size-4-mobile">Best practice: iOS background processing - Background App Refresh Task</h1><div class="content"><p><img src="/Post-Resources/RefreshInBg/RefreshAppBg.png" alt="" title="Cover"></p>
<p>Unlike Android, iOS has restrictions for the use of background processing in an attempt of improving battery life and user experience. When your apps enter to background mode, it’s time developers get out of control of their app. How and when your app gets a chance to execute your task totally depends on the system. At the heart of iOS, Apple uses its own internally-complex algorithm to determines which apps are allowed to run in the background, based on various factors such as the pattern of user activity, current battery state, etc.<br>In this tutorial, we will learn how to request periodic execution time on iOS. After understanding how it works, we will apply this technique to a BLE-based app in some specific cases in the next tutorial.<br>Let’s rock!</p>
<a id="more"></a> 

<h2 id="Foundational-knowledge"><a href="#Foundational-knowledge" class="headerlink" title="Foundational knowledge"></a>Foundational knowledge</h2><p>Before taking deep dive into practice, it’s good to understand how iOS manages application states. It’s been the first time Apple officially announces a video that describes top factors contributing to the app launch times at WWDC (<a href="https://developer.apple.com/videos/play/wwdc2020/10063/?fbclid=IwAR1_oejf0JY9B8yV4d9riMAH4MQsLasO86iVjhwqmAruw2v64_utbuGZIEc">WWDC 2020 - Background execution demystified</a>). To summarize, Apple designs iOS in a way allowing applications to keep its content up to date on one hand. On the other hand, iOS must adapt to its major goals: </p>
<ul>
<li><strong>Battery life</strong>: allowing background execution while maintaining all-day battery life.</li>
<li><strong>Performance</strong>: ensure background execution does not have any negative effect on active usage.</li>
<li><strong>Privacy</strong>: Users should be aware of background tasks based on their particular usage patterns.</li>
<li><strong>Respecting user intent</strong>: if a user takes a certain action, make sure the system responds to correctly.</li>
</ul>
<p>With these goals in mind, here are the top 7 factors that play a role in system scheduling of background execution.</p>
<ul>
<li><strong>Critical low battery</strong>: When the phone is about to run out of battery (&lt; 20%), background execution will be pause by the system to avoid battery usage.</li>
<li><strong>Low power mode</strong>: When users change to phone to low power mode, the user explicitly indicates that the system should preserve battery for critical tasks only. </li>
<li><strong>Background App refresh setting</strong>: The user can toggle the setting to allow or not a specified app can run background tasks.<br><img src="/Post-Resources/RefreshInBg/app_refresh_setting.png" alt="" title="App refresh setting"></li>
<li><strong>App usage</strong>: There is a limit of resources on the phone so that the system must priorities which apps it should allocate resources for. Typically, apps that the user uses the most. Apple also mentioned to “On-device predictive engine” that learns which apps the user often uses and when. The on-device predictive engine will rely on this information to priorities background execution.</li>
<li><strong>App switcher</strong>: Only apps are visible in App Switcher have opportunities to run background tasks.</li>
<li><strong>System budget</strong>: Ensure background activities do not drain battery and data plans, there is a limit of battery and data of background execution throughout the day.</li>
<li><strong>Rate limit</strong>: The system performs sone rate-limiting per launch.</li>
</ul>
<p>and some other factors: Airplane mode, device temperature, display, device lock state, etc.</p>
<p><img src="/Post-Resources/RefreshInBg/factors.png" alt="" title="Factors"></p>
<h2 id="Capabilities"><a href="#Capabilities" class="headerlink" title="Capabilities"></a>Capabilities</h2><p>Make sure your app has added these following capabilities</p>
<p><img src="/Post-Resources/RefreshInBg/BG-Capabilities.png" alt="" title="Capability"></p>
<h2 id="Prior-to-iOS-13"><a href="#Prior-to-iOS-13" class="headerlink" title="Prior to iOS 13"></a>Prior to iOS 13</h2><p>It’s quite simple to set up a background fetch prior to iOS 13.<br>Inside the <code>application(_:didFinishLaunchingWithOptions)</code> method, we should add the following command.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIApplication</span>.shared.setMinimumBackgroundFetchInterval(<span class="type">UIApplication</span>.backgroundFetchIntervalMinimum)</span><br></pre></td></tr></table></figure>
<p>The <code>setMinimumBackgroundFetchInterval</code> specifies the minimum amount of time that must elapse between background fetch executions. However, the exact timing of the event is up to the system. Generally, <code>UIApplicationBackgroundFetchIntervalMinimum</code> is a good default value to use.</p>
<p>Once your app has a chance to perform background tasks, the event <code>application(_:,performFetchWithCompletionHandler)</code> will be triggered.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, performFetchWithCompletionHandler completionHandler: @escaping <span class="params">(UIBackgroundFetchResult)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="type">Logger</span>.shared.debug(<span class="string">"\(Date().toString()) perfom bg fetch"</span>)</span><br><span class="line">    completionHandler(.newData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Don’t forget to call <code>completionHandler</code> callback. If you do not call this callback, the system does not aware your task has been completed, which leads to limiting your app from waking up on the next events</strong></p>
<p>To simulate background fetch, from the tab bar &gt; Debug &gt; Simulate background fetch. Note that it works only when running on real devices.</p>
<p><img src="/Post-Resources/RefreshInBg/simulate_bg_fetch.png" alt="" title="Simulate background fetch"></p>
<iframe width="100%" height="415" src="https://www.youtube.com/embed/oOysGc_f0pA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h2 id="iOS-13-Advance-Background-processing-WWDC-2019-and-Background-execution-demystified-WWDC-2020"><a href="#iOS-13-Advance-Background-processing-WWDC-2019-and-Background-execution-demystified-WWDC-2020" class="headerlink" title="iOS 13+, Advance Background processing - WWDC 2019 and Background execution demystified - WWDC 2020"></a>iOS 13+, Advance Background processing - WWDC 2019 and Background execution demystified - WWDC 2020</h2><p><a href="https://developer.apple.com/videos/play/wwdc2019/707/">At WWDC 2019</a>, Apple introduced a new framework for scheduling background work: <code>BackgroundTasks</code>. This new framework does better support for tasks that are needed to be done in the background. There are two kinds of tasks supported by <code>BackgroundTasks</code> framework: <code>BGAppRefreshTaskRequest</code>, and <code>BGProcessingTaskRequest</code>. With the presence of the new framework, Apple marked deprecated on the old one from iOS 13, and no longer support on MacOS.<br>Firstly, we have to register the identifiers of background tasks executed in our app. Open <code>info.plist</code> file, and add the following information.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;BGTaskSchedulerPermittedIdentifiers&lt;/key&gt;</span><br><span class="line">&lt;array&gt;</span><br><span class="line">    &lt;string&gt;YOUR_REFRESH_TASK_ID&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;YOUR_PROCESSING_TASK_ID&lt;/string&gt;</span><br><span class="line">&lt;/array&gt;</span><br></pre></td></tr></table></figure>

<p>Forget the above step leading to a crash at runtime.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">24</span>:<span class="number">40.648838</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">275</span>:<span class="number">5188</span>] *** <span class="type">Terminating</span> app due to uncaught exception '<span class="type">NSInternalInconsistencyException'</span>, reason: '<span class="type">No</span> launch handler registered <span class="keyword">for</span> task with identifier com.example.bgRefresh'</span><br></pre></td></tr></table></figure>

<p><code>BGAppRefreshTaskRequest</code> is used when you need to execute a task in the background in a short time.<br>Refresh tasks like fetching social media feed, new emails, latest stock prices, etc are appropriate to schedule by <code>BGAppRefreshTaskRequest</code>. 30s is the time the system allows your task to execute per launch.</p>
<p>Several minutes of run times to finish your work when you register a <code>BGProcessingTaskRequest</code>. Tasks such as Core ML training on the device should be registered by a <code>BGProcessingTaskRequest</code>.</p>
<p>To register background tasks, inside the <code>application(_:didFinishLaunchingWithOptions)</code> method, we should add the following command.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: <span class="keyword">Any</span>]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> #available(iOS <span class="number">13</span>, *) &#123;</span><br><span class="line">            <span class="type">BGTaskScheduler</span>.shared.register(forTaskWithIdentifier: appRefreshTaskId, using: <span class="literal">nil</span>) &#123; task <span class="keyword">in</span></span><br><span class="line">                <span class="type">Logger</span>.shared.info(<span class="string">"[BGTASK] Perform bg fetch \(appRefreshTaskId)"</span>)</span><br><span class="line">                task.setTaskCompleted(success: <span class="literal">true</span>)</span><br><span class="line">                <span class="keyword">self</span>.scheduleAppRefresh()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">BGTaskScheduler</span>.shared.register(forTaskWithIdentifier: appProcessingTaskId, using: <span class="literal">nil</span>) &#123; task <span class="keyword">in</span></span><br><span class="line">                <span class="type">Logger</span>.shared.info(<span class="string">"[BGTASK] Perform bg processing \(appProcessingTaskId)"</span>)</span><br><span class="line">                task.setTaskCompleted(success: <span class="literal">true</span>)</span><br><span class="line">                <span class="keyword">self</span>.scheduleBackgroundProcessing()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@available</span>(iOS <span class="number">13.0</span>, *)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scheduleAppRefresh</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">BGAppRefreshTaskRequest</span>(identifier: <span class="string">"YOUR_REFRESH_TASK_ID"</span>)</span><br><span class="line"></span><br><span class="line">        request.earliestBeginDate = <span class="type">Date</span>(timeIntervalSinceNow: <span class="number">5</span> * <span class="number">60</span>) <span class="comment">// Refresh after 5 minutes.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> <span class="type">BGTaskScheduler</span>.shared.submit(request)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not schedule app refresh task \(error.localizedDescription)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@available</span>(iOS <span class="number">13.0</span>, *)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scheduleBackgroundProcessing</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">BGProcessingTaskRequest</span>(identifier: appProcessingTaskId)</span><br><span class="line">        request.requiresNetworkConnectivity = <span class="literal">true</span> <span class="comment">// Need to true if your task need to network process. Defaults to false.</span></span><br><span class="line">        request.requiresExternalPower = <span class="literal">true</span> <span class="comment">// Need to true if your task requires a device connected to power source. Defaults to false.</span></span><br><span class="line"></span><br><span class="line">        request.earliestBeginDate = <span class="type">Date</span>(timeIntervalSinceNow: <span class="number">5</span> * <span class="number">60</span>) <span class="comment">// Process after 5 minutes.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> <span class="type">BGTaskScheduler</span>.shared.submit(request)</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not schedule image fetch: (error)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>One more thing that needs to be done. When the app enters to the background, we will start scheduling background tasks.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationDidEnterBackground</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">    <span class="type">Logger</span>.shared.info(<span class="string">"App did enter background"</span>)</span><br><span class="line">    <span class="keyword">if</span> #available(iOS <span class="number">13</span>, *) &#123;</span><br><span class="line">        <span class="keyword">self</span>.scheduleAppRefresh()</span><br><span class="line">        <span class="keyword">self</span>.scheduleBackgroundProcessing()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>As always, It’s important to call <code>task.setTaskCompleted(success: true)</code> as quick as possible</strong>.<br>You might notice that after calling <code>task.setTaskCompleted(success: true)</code>, we need to call <code>self.scheduleAppRefresh()</code> and <code>self.scheduleBackgroundProcessing()</code> again to re-schedule these tasks to the system.</p>
<h3 id="Simulate-background-task-and-background-processing"><a href="#Simulate-background-task-and-background-processing" class="headerlink" title="Simulate background task and background processing"></a>Simulate background task and background processing</h3><p>Fortunately, Apple supports a way to trigger background execution.<br>After submitting your task to the system, pause the application by any break point. Then, enter the following command to the Xcode console.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e -l objc -- (void)[[BGTaskScheduler sharedScheduler] _simulateLaunchForTaskWithIdentifier:@<span class="string">"YOUR_REFRESH_TASK_ID || YOUR_PROCESSING_TASK_ID"</span>]</span><br></pre></td></tr></table></figure>
<p>The output should be</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">53</span>:<span class="number">58.628667</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17115</span>] 💚-<span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">53</span>:<span class="number">58.628</span> +<span class="number">0700</span> <span class="type">Start</span> schedule app refresh</span><br><span class="line">(lldb) e -l objc -- (void)[[<span class="type">BGTaskScheduler</span> sharedScheduler] _simulateLaunchForTaskWithIdentifier:@<span class="string">"com.example.bgRefresh"</span>]</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">01.927263</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">16973</span>] <span class="type">Simulating</span> launch <span class="keyword">for</span> task with identifier com.example.bgRefresh</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">03.669153</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17095</span>] <span class="type">Starting</span> simulated task: &lt;decode: missing data&gt;</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.560697</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17095</span>] <span class="type">Marking</span> simulated task complete: &lt;<span class="type">BGAppRefreshTask</span>: com.example.bgRefresh&gt;</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.560750</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17012</span>] 💙-<span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">06.045</span> +<span class="number">0700</span> [<span class="type">BGTASK</span>] <span class="type">Perform</span> bg fetch com.example.bgRefresh</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.563846</span>+<span class="number">0700</span> <span class="type">TestBgTask</span>[<span class="number">381</span>:<span class="number">17012</span>] 💚-<span class="number">2020</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">54</span>:<span class="number">07.562</span> +<span class="number">0700</span> <span class="type">Start</span> schedule app refresh</span><br></pre></td></tr></table></figure>

<iframe width="100%" height="415" src="https://www.youtube.com/embed/e6KFwzZKmns" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<h2 id="Expectation-vs-Reality"><a href="#Expectation-vs-Reality" class="headerlink" title="Expectation vs Reality"></a>Expectation vs Reality</h2><p>You might expect that background execution would be evenly distributes through out the day.<br><img src="/Post-Resources/RefreshInBg/Expectation.png" alt="" title="Expectation"></p>
<p>However, here is what we observe in reality. Because of the 7 factors I introduced at the beginning of this tutorial, the “On-device predictive engine” learns the user usage pattern and understands that the user typically opens the app in the morning, lunchtime, and in the evening. That’s why the system will allow your background tasks to launch just before the user foregrounds the app. Other factors that affect the result are if the user toggled “Low power mode”, or if the phone fell into the critical low battery state.<br><img src="/Post-Resources/RefreshInBg/Reality.png" alt="" title="Reality"></p>
<h2 id="Best-advices"><a href="#Best-advices" class="headerlink" title="Best advices"></a>Best advices</h2><ul>
<li>Background tasks will not be run until the first device unlocks after the reboot.</li>
<li>We can check if the user is in low power mode:<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessInfo</span>.processInfo.isLowPowerModeEnabled</span><br><span class="line"><span class="type">NSProcessInfoPowerStateDidChange</span></span><br></pre></td></tr></table></figure></li>
<li>We also can check the “background refresh setting” status.<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIApplication</span>.shared.backgroundRefreshStatus</span><br><span class="line"><span class="type">UIApplication</span>.backgroundStatusDidChangeNotification</span><br></pre></td></tr></table></figure></li>
<li>Minimize data usage: Using thumbnails instead of full images, and only download what’s really necessary.</li>
<li>Minimize power consumption: avoid unnecessary hardware usage such as GPS, accelerometer, etc. Also, make sure you complete the task as soon as possible.</li>
<li>Use <code>BackgroundURLSession</code> to offload the work from the app to the system.</li>
</ul>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>In this post, we take a deep dive into what factors contributed to your background executions, and understand are key differences between <code>BGAppRefreshTaskRequest</code> and  <code>BGProcessingTaskRequest</code>. We also take a demo project to see how it actually works in reality.<br>Next time, you can choose what kind of request is most appropriate to your tasks, and how you can respond gracefully to your user’s intent.<br>Hopefully, the information that this post brings in helps you build better applications: freshness and optimization.<br>There is another technique to wake your app up, silent notification. We will talk about it in the next tutorial.<br>Happy weekend!</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="https://developer.apple.com/videos/play/wwdc2020/10063">Background execution demystified WWDC 2020</a></li>
<li><a href="https://developer.apple.com/videos/play/wwdc2019/707/">Advances in App Background Execution WWDC 2019</a></li>
</ol>
</div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5e9474199d6bcc0012d5bba6&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="https://ko-fi.com/uynguyen" style="background-color:rgba(255,128,62,.87);border-color:transparent;color:white;" target="_blank" rel="noopener"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button is-warning donate" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="uynguyen.itus@gmail.com"><input type="hidden" name="currency_code" value="USD"></form></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/02/25/WWDC-2020-Top-reasons-why-app-get-killed-in-background/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">WWDC 2020 - Top reasons why app get killed in background</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/09/26/Review-book-RxSwift-Reactive-Programming-with-Swift/"><span class="level-item">Review book: RxSwift Reactive Programming with Swift</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://uynguyen.github.io/2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/';
            this.page.identifier = '2020/09/26/Best-practice-iOS-background-processing-Background-App-Refresh-Task/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'uynguyen-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen"></figure><p class="title is-size-4 is-block line-height-inherit">Uy Nguyen</p><p class="is-size-6 is-block">Software engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-envelope mr-1"></i><span>uynguyen.itus@gmail.com</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">55</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-rounded" style="background-color:#f14668e3;color:white;font-weight:bold;" href="https://ko-fi.com/uynguyen" target="_blank" rel="noopener">if 👍 then Buy me a Coffee</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/uynguyen"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://www.linkedin.com/in/uynguyen505"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://uynguyen.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Uy Nguyen</span></span><span class="level-right"><span class="level-item tag">uynguyen.github.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recent</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2024-08-04T05:10:39.000Z">2024-08-04</time></p><p class="title is-6"><a class="link-muted" href="/2024/08/04/Android-Bluetooth-A-Pitfall/">Android Bluetooth: A Pitfall</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-06-30T03:48:09.000Z">2024-06-30</time></p><p class="title is-6"><a class="link-muted" href="/2024/06/30/Best-practice-iOS-vs-Android-Bluetooth/">Best practice: iOS vs Android Bluetooth</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-03-23T03:54:36.081Z">2024-03-23</time></p><p class="title is-6"><a class="link-muted" href="/2024/03/23/Core-Bluetooth-on-WatchOS/">Core Bluetooth on WatchOS</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2024-01-12T09:07:40.000Z">2024-01-12</time></p><p class="title is-6"><a class="link-muted" href="/2024/01/12/Protobuf/">Protobuf In Practice</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-11-09T13:18:20.000Z">2023-11-09</time></p><p class="title is-6"><a class="link-muted" href="/2023/11/09/What-s-new-of-Appclip-on-iOS-17/">What&#039;s new of Appclip on iOS 17?</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Appclip/"><span class="tag">Appclip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLE/"><span class="tag">BLE</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bluetooth/"><span class="tag">Bluetooth</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Books/"><span class="tag">Books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocoa/"><span class="tag">Cocoa</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Concurrency/"><span class="tag">Concurrency</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Conference/"><span class="tag">Conference</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Core-Data/"><span class="tag">Core Data</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CoreBluetooh/"><span class="tag">CoreBluetooh</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CrossPlatform/"><span class="tag">CrossPlatform</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Design-Patterns/"><span class="tag">Design Patterns</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DispatchQueue/"><span class="tag">DispatchQueue</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Memory-management/"><span class="tag">Memory management</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Notification/"><span class="tag">Notification</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Objective-C/"><span class="tag">Objective-C</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operations/"><span class="tag">Operations</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ReactNative/"><span class="tag">ReactNative</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Software-Architecture/"><span class="tag">Software Architecture</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Study/"><span class="tag">Study</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UI/"><span class="tag">UI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UIStackView/"><span class="tag">UIStackView</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UML/"><span class="tag">UML</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vendor/"><span class="tag">Vendor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WatchOS/"><span class="tag">WatchOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Web-Bluetooth/"><span class="tag">Web Bluetooth</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/books/"><span class="tag">books</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iBeacon/"><span class="tag">iBeacon</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag is-grey-lightest">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/study/"><span class="tag">study</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/Post-Resources/UyNguyen.jpg" alt="Uy Nguyen" height="28"></a><p class="size-small"><span>&copy; Uy Nguyen</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://uynguyen.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>