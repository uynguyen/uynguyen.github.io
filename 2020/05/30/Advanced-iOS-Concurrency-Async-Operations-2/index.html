<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Advanced iOS Concurrency: Async Operations [2] | Uy Nguyen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="In the previous post, Advanced iOS Concurrency: Operations, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover im">
<meta property="og:type" content="article">
<meta property="og:title" content="Advanced iOS Concurrency: Async Operations [2]">
<meta property="og:url" content="https://uynguyen.github.io/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/index.html">
<meta property="og:site_name" content="Uy Nguyen">
<meta property="og:description" content="In the previous post, Advanced iOS Concurrency: Operations, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover im">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/Operations_2/operations.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/Operations_2/Async_Operation_State.png">
<meta property="og:image" content="https://uynguyen.github.io/Post-Resources/Operations_2/final.gif">
<meta property="article:published_time" content="2020-05-30T10:02:31.000Z">
<meta property="article:modified_time" content="2024-03-23T03:54:36.080Z">
<meta property="article:author" content="Uy Nguyen">
<meta property="article:tag" content="Concurrency">
<meta property="article:tag" content="Operations">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://uynguyen.github.io/Post-Resources/Operations_2/operations.png">
  
    <link rel="alternate" href="/atom.xml" title="Uy Nguyen" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Uy Nguyen</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Be a Software Engineer, not a Coder.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://uynguyen.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Advanced-iOS-Concurrency-Async-Operations-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/" class="article-date">
  <time datetime="2020-05-30T10:02:31.000Z" itemprop="datePublished">2020-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Advanced iOS Concurrency: Async Operations [2]
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/Post-Resources/Operations_2/operations.png" alt="" title="Operations"></p>
<p>In the previous post, <a href="/2020/05/16/iOS-Concurrency-Operations">Advanced iOS Concurrency: Operations</a>, we walked through the Operation concepts on iOS and made a demo application that fetches some posts of mine. After downloading the cover images, they will be applied to a simple filter, then be displayed in a table view. The application, however, has not been completed yet. There’s something that went wrong with our app making the app did not show downloaded images properly. In this tutorial, we will continue where we left off.<br>Get ready!</p>
<a id="more"></a> 
<h2 id="Operation-life-cycle"><a href="#Operation-life-cycle" class="headerlink" title="Operation life cycle"></a>Operation life cycle</h2><p>To find out why our app did not function properly, let’s review the current source code</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadImageOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> !isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">URLSession</span>.shared.dataTask(with: <span class="keyword">self</span>.url, completionHandler: &#123; (data, res, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span>,</span><br><span class="line">                <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.outputImage = <span class="type">UIImage</span>(data: data)</span><br><span class="line">        &#125;).resume()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following image describes the changes in states of operations.<br><img src="/Post-Resources/Operations_2/Async_Operation_State.png" alt="" title="Async_Operation_State"></p>
<p>When the <code>main</code> method gets called, it will execute our asynchronous task and then exit immediately making the state of the operation switch to <code>isFinish</code>. At that point, our asynchronous task actually has not completed yet.<br>Currently, we’re calling to download an image inside the <code>main</code> method of the Operation. The root cause is related to the Operation Life Cycle itself. Thus, to support asynchronous operations in our app, we need to manually manage states of operations.</p>
<h2 id="Key-Value-Observing"><a href="#Key-Value-Observing" class="headerlink" title="Key-Value Observing"></a><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html" target="_blank" rel="noopener">Key-Value Observing</a></h2><p>Before implementing our custom Async Operation class, we need to learn a new concept first: KVO. I assume that you’ve not heard about this concept so we will have a quick look at it first.<br>Key-Value Observing, aka KVO, is one of the techniques for observing the state changes of an object in Objective-C and Swift. Whenever the value of the observed properties changed, the observing block of code will execute. At the heart of KVO, the main concept is based on the Observer Pattern.<br>Swift classes that are inherited from <code>NSObject</code> class have methods to allow other objects to observe their properties.</p>
<blockquote>
<p>Key-value observing provides a mechanism that allows objects to be notified of changes to specific properties of other objects. It is particularly useful for communication between model and controller layers in an application.</p>
</blockquote>
<p>Let’s create a Playground to test it.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditCard</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">dynamic</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> number: <span class="type">Int</span> = <span class="number">1000</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">increaseNumber</span><span class="params">(by value: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.number += value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cretdit: <span class="type">CreditCard</span></span><br><span class="line">    <span class="keyword">var</span> kvoToken: <span class="type">NSKeyValueObservation?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(cretdit: <span class="type">CreditCard</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.cretdit = cretdit</span><br><span class="line">        kvoToken = <span class="keyword">self</span>.cretdit.observe(\.number, options: .new) &#123; (credit, change) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newNumber = change.newValue <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"New number is \(newNumber)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        kvoToken?.invalidate()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> credit = <span class="type">CreditCard</span>()</span><br><span class="line"><span class="keyword">let</span> person = <span class="type">Person</span>(cretdit: credit)</span><br><span class="line">credit.increaseNumber(by: <span class="number">500</span>)</span><br></pre></td></tr></table></figure>

<p>Here, I define two classes: <code>CreditCard</code> and <code>Person</code>. A <code>Person</code> object holds a <code>CreditCard</code> object as a property. What I want is whenever the <code>number</code> property of the credit card gets changed, the person will be notified. Here is KVO comes.<br>Run the above code in the playground, you should see the log <code>New number is \(newNumber)</code> print out on your console.</p>
<p>Why should we need to know about KVO? The answer is because the Operation class uses KVO notification. Whenever the state of Operation changes, a KVO notification will be sent.<br>Without KVO notifications, the OperationQueue won’t be able to observe the state of our operations so that it can not get updated correctly. Thus, when we manage the state of operation by ourselves, we must ensure those KVO notifications are sent properly.</p>
<h2 id="Async-Operation"><a href="#Async-Operation" class="headerlink" title="Async Operation"></a>Async Operation</h2><p>Let’s create <code>AsyncOperation</code> class inherited from the <code>Operation</code> class.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncOperation</span>: <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">State</span>: <span class="title">String</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> ready, executing, finished</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> keyPath: <span class="type">String</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"is\(rawValue.capitalized)"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The rest of code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next, We declare a property to keep track the state of the object.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> state = <span class="type">State</span>.ready &#123;</span><br><span class="line">    <span class="keyword">willSet</span> &#123;</span><br><span class="line">        willChangeValue(forKey: newValue.keyPath)</span><br><span class="line">        willChangeValue(forKey: state.keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">        didChangeValue(forKey: oldValue.keyPath)</span><br><span class="line">        didChangeValue(forKey: state.keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>Operation</code> base class needs to know the changes of both the old state and new state.<br>Take a specified case as an example, the state currently is <code>ready</code>, then we set the state to <code>executing</code>. There are 4 KVO notifications should be sent:</p>
<ul>
<li>Firstly, notify the willChangeValue for <code>isReady</code>.</li>
<li>Then. notify the willChangeValue for <code>executing</code>.</li>
<li>After that, notfiy the willChange for <code>isReady</code>.</li>
<li>Finally, notfiy the willChange for <code>executing</code>.</li>
</ul>
<p>After that, We override the properties of states.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isReady: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.isReady &amp;&amp; state == .ready</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isExecuting: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state == .executing</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isFinished: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state == .finished</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> isAsynchronous: <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s all for managing the state of Async Operation class. </p>
<p>When adding an operation to an operation queue, the <code>start</code> method is what gets called first. then it will call the <code>main</code> method of the operation executing the main block of code you have assigned to the operation.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    main()</span><br><span class="line">    state = .executing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Remember when I mentioned that Operation has killer features that make it surpass GDC? The first one is dependencies and the other one is the capability of canceling a running operation. It’s very useful in a case where we want to stop operations that are irrelevant at a certain time. For example, to cancel downloading data when the user scrolls the table making some cells disappear.<br>Let’s add this feature to our Async Operation class.<br>First, we need to modify the <code>start</code> method to check the <code>isCancelled</code> property before actually calling the <code>main</code> method.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> isCancelled &#123;</span><br><span class="line">        state = .finished</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    main()</span><br><span class="line">    state = .executing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And then override the <code>cancel</code> method to update the state to <code>finished</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    state = .finished</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At this point, we’ve finished implementing our <code>Async Operation</code> class. It’s time to mix everything together in our app.</p>
<h2 id="Adding-this-all-together"><a href="#Adding-this-all-together" class="headerlink" title="Adding this all together"></a>Adding this all together</h2><p>Because the <code>DownloadImageOperation</code> class executes asynchronously, we can not set <code>Operation</code> class as its base class, we now set <code>AsyncOperation</code> instead. Kindly note that to support canceling in <code>DownloadImageOperation</code> class, we will keep the return value of creating a data task as a property of this class so that we can cancel this <code>URLSessionDataTask</code> later.<br>The <code>DownloadImageOperation</code> class will look like below.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadImageOperation</span>: <span class="title">AsyncOperation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">URL</span></span><br><span class="line">    <span class="keyword">var</span> outputImage: <span class="type">UIImage?</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> task: <span class="type">URLSessionDataTask?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(url: <span class="type">URL</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.url = url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.task = <span class="type">URLSession</span>.shared.dataTask(with: <span class="keyword">self</span>.url, completionHandler: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] (data, res, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> `<span class="keyword">self</span>` = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">defer</span> &#123; <span class="keyword">self</span>.state = .finished &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">guard</span> !<span class="keyword">self</span>.isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">guard</span> error == <span class="literal">nil</span>,</span><br><span class="line">                <span class="keyword">let</span> data = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.outputImage = <span class="type">UIImage</span>(data: data)</span><br><span class="line">        &#125;)</span><br><span class="line">        task?.resume()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.cancel()</span><br><span class="line">        task?.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s back to our main <code>ViewController</code>. To cancel the running operations, we first add new dictionary as a property of <code>ViewController</code> which tracks all running operations for each table view cell at a corresponding index path.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> operations: [<span class="type">IndexPath</span>: [<span class="type">Operation</span>]] = [:]</span><br></pre></td></tr></table></figure>

<p>Inside the <code>func tableView(_ tableView:cellForRowAt indexPath:)</code> delegate, after adding two operations to the operation queue, we will also add them to the <code>operations</code> dictionary for tracking. Additionally, if there is an operation for this index path, cancel it before holding the new one.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> existingOperations = operations[indexPath] &#123;</span><br><span class="line">    <span class="keyword">for</span> operation <span class="keyword">in</span> existingOperations &#123;</span><br><span class="line">        operation.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">operations[indexPath] = [grayScaleOpt, downloadOpt]</span><br></pre></td></tr></table></figure>

<p>When the user scrolls the table, some cells disappear and the delegate <code>func tableView(_ tableView:didEndDisplaying cell:indexPath:)</code> gets called. At that point, we’ll also cancel the running operations for that cell ensuring that only operations of visible cells are executing.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didEndDisplaying cell: UITableViewCell, forRowAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> operations = operations[indexPath] &#123;</span><br><span class="line">        <span class="keyword">for</span> operation <span class="keyword">in</span> operations &#123;</span><br><span class="line">            operation.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center">

<p><img src="/Post-Resources/Operations_2/final.gif" alt="" title="Final app"></p>
</div>

<p>Now, you should see the app now works properly. Additionally, by starting and canceling the operations wisely, we’re saving the network traffic as well as reduce the battery consumption. Those things can make our app run faster.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>There are some benefits of <code>Operation</code> over GCD that keep our source code maintainable and reusable.<br>The last to mention, please careful when using Operation or GCD because Concurrency sometimes introduces bugs that are not always transparent to find and fix. <a href="http://localhost:4000/2017/10/20/Review-Book-Clean-Code/" target="_blank" rel="noopener">In Clean Code Book</a>, Robert C. Martin states some important points when working with multiple threads</p>
<blockquote>
<p>There are some basic definitions we should know when we talk about concurrency and threads: Bound resources, mutual exclusion, starvation, deadlock, and livelock.</p>
</blockquote>
<blockquote>
<p>Concurrency does not always improve performance. It sometimes incurs some overhead and bugs come from it are not usually repeatable.</p>
</blockquote>
<blockquote>
<p>Limit the access of the data that is shared between more than two threads. Use copies of data if there is a chance.</p>
</blockquote>
<blockquote>
<p>Keep the synchronized sections as small as possible because Locks create delays and add overhead. They are expensive.</p>
</blockquote>
<blockquote>
<p>Multithreaded code behaves differently in different environments: Run tests in every potential deployment environment.</p>
</blockquote>
<p>You can find the final project via the <a href="https://github.com/uynguyen/iOS-Operations" target="_blank" rel="noopener">link</a><br>Thank you for reading.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li>Chapter 6: Operations, Concurrency By Tutorials - Multithreading in Swift with GCD and Operations, Raywenderlich,</li>
<li>Chapter 7: Concurrency and Multitasking, iOS 8 Swift Programming Cookbook, O’Reilly.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://uynguyen.github.io/2020/05/30/Advanced-iOS-Concurrency-Async-Operations-2/" data-id="clu3nvc5l0000xzvqeqmle9ba" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Concurrency/" rel="tag">Concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Operations/" rel="tag">Operations</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/06/14/Review-book-Building-Applications-With-iBeacon/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Review book: Building Applications With iBeacon
        
      </div>
    </a>
  
  
    <a href="/2020/05/16/iOS-Concurrency-Operations/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Advanced iOS Concurrency: Operations [1]</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Appclip/" rel="tag">Appclip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BLE/" rel="tag">BLE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bluetooth/" rel="tag">Bluetooth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Books/" rel="tag">Books</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cocoa/" rel="tag">Cocoa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Concurrency/" rel="tag">Concurrency</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Conference/" rel="tag">Conference</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Core-Data/" rel="tag">Core Data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CoreBluetooh/" rel="tag">CoreBluetooh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CrossPlatform/" rel="tag">CrossPlatform</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Patterns/" rel="tag">Design Patterns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DispatchQueue/" rel="tag">DispatchQueue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memory-management/" rel="tag">Memory management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Notification/" rel="tag">Notification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Objective-C/" rel="tag">Objective-C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Operations/" rel="tag">Operations</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReactNative/" rel="tag">ReactNative</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Software-Architecture/" rel="tag">Software Architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Study/" rel="tag">Study</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/" rel="tag">Swift</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/" rel="tag">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UIStackView/" rel="tag">UIStackView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UML/" rel="tag">UML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vendor/" rel="tag">Vendor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WatchOS/" rel="tag">WatchOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web-Bluetooth/" rel="tag">Web Bluetooth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/books/" rel="tag">books</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iBeacon/" rel="tag">iBeacon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macOS/" rel="tag">macOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/study/" rel="tag">study</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 11.67px;">Android</a> <a href="/tags/Appclip/" style="font-size: 10px;">Appclip</a> <a href="/tags/BLE/" style="font-size: 18.33px;">BLE</a> <a href="/tags/Bluetooth/" style="font-size: 13.33px;">Bluetooth</a> <a href="/tags/Books/" style="font-size: 10px;">Books</a> <a href="/tags/Cocoa/" style="font-size: 10px;">Cocoa</a> <a href="/tags/Concurrency/" style="font-size: 15px;">Concurrency</a> <a href="/tags/Conference/" style="font-size: 10px;">Conference</a> <a href="/tags/Core-Data/" style="font-size: 10px;">Core Data</a> <a href="/tags/CoreBluetooh/" style="font-size: 11.67px;">CoreBluetooh</a> <a href="/tags/CrossPlatform/" style="font-size: 10px;">CrossPlatform</a> <a href="/tags/Design-Patterns/" style="font-size: 10px;">Design Patterns</a> <a href="/tags/DispatchQueue/" style="font-size: 10px;">DispatchQueue</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Memory-management/" style="font-size: 10px;">Memory management</a> <a href="/tags/Notification/" style="font-size: 11.67px;">Notification</a> <a href="/tags/Objective-C/" style="font-size: 10px;">Objective-C</a> <a href="/tags/Operations/" style="font-size: 11.67px;">Operations</a> <a href="/tags/ReactNative/" style="font-size: 10px;">ReactNative</a> <a href="/tags/Software-Architecture/" style="font-size: 10px;">Software Architecture</a> <a href="/tags/Study/" style="font-size: 11.67px;">Study</a> <a href="/tags/Swift/" style="font-size: 16.67px;">Swift</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/UIStackView/" style="font-size: 10px;">UIStackView</a> <a href="/tags/UML/" style="font-size: 10px;">UML</a> <a href="/tags/Vendor/" style="font-size: 10px;">Vendor</a> <a href="/tags/WatchOS/" style="font-size: 10px;">WatchOS</a> <a href="/tags/Web-Bluetooth/" style="font-size: 10px;">Web Bluetooth</a> <a href="/tags/books/" style="font-size: 10px;">books</a> <a href="/tags/iBeacon/" style="font-size: 11.67px;">iBeacon</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/macOS/" style="font-size: 10px;">macOS</a> <a href="/tags/study/" style="font-size: 10px;">study</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/30/Best-practice-iOS-vs-Android-Bluetooth/">Best practice: iOS vs Android Bluetooth</a>
          </li>
        
          <li>
            <a href="/2024/03/23/Core-Bluetooth-on-WatchOS/">Core Bluetooth on WatchOS</a>
          </li>
        
          <li>
            <a href="/2024/01/12/Protobuf/">Protobuf In Practice</a>
          </li>
        
          <li>
            <a href="/2023/11/09/What-s-new-of-Appclip-on-iOS-17/">What&#39;s new of Appclip on iOS 17?</a>
          </li>
        
          <li>
            <a href="/2023/07/22/Schedule-task-in-background-from-foreground-service/">Schedule task in background from foreground service</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 Uy Nguyen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>